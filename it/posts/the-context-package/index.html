<!doctype html><html lang=it dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="it"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione &#183; Git Push and Run</title><meta name=title content="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione &#183; Git Push and Run"><meta name=description content="Ingegnere Software e Cloud Architect. Scrivo di Go, Python, AWS e sistemi AI."><meta name=keywords content="golang,context,"><link rel=canonical href=https://manuelfedele.github.io/it/posts/the-context-package/><meta name=author content="Manuel Fedele"><link href=https://github.com/manuelfedele rel=me><link href=https://linkedin.com/in/manuel-fedele rel=me><meta property="og:url" content="https://manuelfedele.github.io/it/posts/the-context-package/"><meta property="og:site_name" content="Git Push and Run"><meta property="og:title" content="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione"><meta property="og:description" content="Il package context esiste per un motivo principale: la gestione del ciclo di vita delle goroutine. Fornisce un modo standard e componibile per propagare segnali di cancellazione, deadline e metadati request-scoped attraverso i confini delle API. Capire come funziona in produzione fa la differenza tra un servizio che si spegne pulitamente e uno che perde goroutine sotto carico. Ogni servizio Go non banale usa context. Lo si passa dagli HTTP handler alle query sul database, dagli interceptor gRPC alle chiamate API downstream. Ma molti ingegneri lo trattano come poco piu di una convenzione per soddisfare le firme delle funzioni. Questo post spiega come context funziona davvero, dove fallisce silenziosamente quando viene mal utilizzato, e i pattern che contano in produzione."><meta property="og:locale" content="it"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-03T20:36:29+01:00"><meta property="article:modified_time" content="2023-01-03T20:36:29+01:00"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Context"><meta name=twitter:card content="summary"><meta name=twitter:title content="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione"><meta name=twitter:description content="Il package context esiste per un motivo principale: la gestione del ciclo di vita delle goroutine. Fornisce un modo standard e componibile per propagare segnali di cancellazione, deadline e metadati request-scoped attraverso i confini delle API. Capire come funziona in produzione fa la differenza tra un servizio che si spegne pulitamente e uno che perde goroutine sotto carico. Ogni servizio Go non banale usa context. Lo si passa dagli HTTP handler alle query sul database, dagli interceptor gRPC alle chiamate API downstream. Ma molti ingegneri lo trattano come poco piu di una convenzione per soddisfare le firme delle funzioni. Questo post spiega come context funziona davvero, dove fallisce silenziosamente quando viene mal utilizzato, e i pattern che contano in produzione."><link type=text/css rel=stylesheet href=/css/main.bundle.min.726dfbf42bcd66e35e2d7258d72fe8fe77509ff76d153e2b46cdbae9c3af9620653459f0119a72d2af4a9b4bc446652d244ad58743d0290e5d8e09e3983b98e5.css integrity="sha512-cm379CvNZuNeLXJY1y/o/ndQn/dtFT4rRs266cOvliBlNFnwEZpy0q9Km0vERmUtJErVh0PQKQ5djgnjmDuY5Q=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.88278edec77139635e1ad294df5b32b7be9338191c5252d3f6f451ace5852d5f82390cccacedab9c64739d8e068b7e8502895cf8f951060c0368f9a73709fcb7.js integrity="sha512-iCeO3sdxOWNeGtKU31syt76TOBkcUlLT9vRRrOWFLV+COQzMrO2rnGRznY4Gi36FAolc+PlRBgwDaPmnNwn8tw==" data-copy=Copia data-copied=Copiato></script><script defer type=text/javascript src=/js/mermaid.bundle.c63c50c6884d5e5a17085b7ea24a2ef1f2c96af692b3e243dfab2ab9ef6e6c045a111b16d5cd3ce4d3f1a4919e6a86c4d49c16f5cf9b44db6dd7f6ffbc8d4b49.js integrity="sha512-xjxQxohNXloXCFt+okou8fLJavaSs+JD36sque9ubARaERsW1c085NPxpJGeaobE1JwW9c+bRNtt1/b/vI1LSQ=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione","headline":"Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione","inLanguage":"it","url":"https://manuelfedele.github.io/it/posts/the-context-package/","author":{"@type":"Person","name":"Manuel Fedele"},"copyrightYear":"2023","dateCreated":"2023-01-03T20:36:29\u002b01:00","datePublished":"2023-01-03T20:36:29\u002b01:00","dateModified":"2023-01-03T20:36:29\u002b01:00","keywords":["golang","context"],"mainEntityOfPage":"true","wordCount":"1639"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Salta al contenuto principale</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/it/ class="text-base font-medium truncate min-w-0 shrink">Git Push and Run</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/it/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title=Posts><span class="text-base font-medium break-normal">Blog
</span></a><a href=/it/about/ class="flex items-center bf-icon-color-hover" aria-label="Chi sono" title="Chi sono"><span class="text-base font-medium break-normal">Chi sono
</span></a><a href=/it/coaching/ class="flex items-center bf-icon-color-hover" aria-label=Coaching title=Coaching><span class="text-base font-medium break-normal">Coaching
</span></a><a href=https://github.com/manuelfedele target=_blank class="flex items-center bf-icon-color-hover" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione">IT</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/the-context-package/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="The Go context Package: Cancellation, Timeouts, and Propagation in Production">EN
</span></a><a href=/it/posts/the-context-package/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione">IT</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Cerca (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Cerca (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/it/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Blog</span></a></div><div class=px-2><a href=/it/about/ aria-label="Chi sono" class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title="Chi sono" class="text-2xl font-bold tracking-tight">Chi sono</span></a></div><div class=px-2><a href=/it/coaching/ aria-label=Coaching class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Coaching class="text-2xl font-bold tracking-tight">Coaching</span></a></div><div class=px-2><a href=https://github.com/manuelfedele aria-label=github target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span><span title class="text-2xl font-bold tracking-tight"></span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione">IT</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/the-context-package/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="The Go context Package: Cancellation, Timeouts, and Propagation in Production">EN
</span></a><a href=/it/posts/the-context-package/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione">IT</span></a></li></ul></div></div></nav></div></div></div></div></div><script>(function(){var t,n,e=document.querySelector(".main-menu");if(!e)return;t=window.location.pathname,n=e.querySelectorAll('a[href="'+t+'"]'),n.forEach(function(e){var t=e.querySelectorAll("span");t.forEach(function(e){e.classList.add("active")})})})()</script></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src="https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=1200&amp;q=85" role=presentation loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-xl bg-neutral-100/75 dark:bg-neutral-800/60"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url="https://images.unsplash.com/photo-1515879218367-8466d910aaa4?w=1200&amp;q=85"></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Il package context di Go: Cancellazione, Timeout e Propagazione in Produzione</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-01-03T20:36:29+01:00>3 gennaio 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">8 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/context/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Context</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Indice dei contenuti</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#cosa-fa-context-e-cosa-non-fa>Cosa fa context (e cosa non fa)</a></li><li><a href=#lanti-pattern-della-chiave-di-context>L&rsquo;anti-pattern della chiave di context</a></li><li><a href=#cancellazione-delle-goroutine-con-select>Cancellazione delle goroutine con select</a></li><li><a href=#cancellazione-degli-http-handler>Cancellazione degli HTTP handler</a></li><li><a href=#http-client-con-timeout>HTTP client con timeout</a></li><li><a href=#query-al-database-con-context>Query al database con context</a></li><li><a href=#withvalue-quando-usarlo-e-quando-no>WithValue: quando usarlo e quando no</a></li><li><a href=#architettura-propagazione-del-context-in-una-richiesta>Architettura: propagazione del context in una richiesta</a></li><li><a href=#errori-comuni>Errori comuni</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Indice dei contenuti</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#cosa-fa-context-e-cosa-non-fa>Cosa fa context (e cosa non fa)</a></li><li><a href=#lanti-pattern-della-chiave-di-context>L&rsquo;anti-pattern della chiave di context</a></li><li><a href=#cancellazione-delle-goroutine-con-select>Cancellazione delle goroutine con select</a></li><li><a href=#cancellazione-degli-http-handler>Cancellazione degli HTTP handler</a></li><li><a href=#http-client-con-timeout>HTTP client con timeout</a></li><li><a href=#query-al-database-con-context>Query al database con context</a></li><li><a href=#withvalue-quando-usarlo-e-quando-no>WithValue: quando usarlo e quando no</a></li><li><a href=#architettura-propagazione-del-context-in-una-richiesta>Architettura: propagazione del context in una richiesta</a></li><li><a href=#errori-comuni>Errori comuni</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><div class="lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl">Il package <code>context</code> esiste per un motivo principale: la gestione del ciclo di vita delle goroutine. Fornisce un modo standard e componibile per propagare segnali di cancellazione, deadline e metadati request-scoped attraverso i confini delle API. Capire come funziona in produzione fa la differenza tra un servizio che si spegne pulitamente e uno che perde goroutine sotto carico.</div><p>Ogni servizio Go non banale usa <code>context</code>. Lo si passa dagli HTTP handler alle query sul database, dagli interceptor gRPC alle chiamate API downstream. Ma molti ingegneri lo trattano come poco piu di una convenzione per soddisfare le firme delle funzioni. Questo post spiega come <code>context</code> funziona davvero, dove fallisce silenziosamente quando viene mal utilizzato, e i pattern che contano in produzione.</p><h2 class="relative group">Cosa fa context (e cosa non fa)<div id=cosa-fa-context-e-cosa-non-fa class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cosa-fa-context-e-cosa-non-fa aria-label=Ancora>#</a></span></h2><p>L&rsquo;interfaccia <code>context.Context</code> ha quattro metodi:</p><div class=highlight-wrapper><div class=codeblock-title>context interface</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> Context <span style=color:#81a1c1;font-weight:700>interface</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#88c0d0>Deadline</span><span style=color:#eceff4>()</span> <span style=color:#eceff4>(</span>deadline time<span style=color:#eceff4>.</span>Time<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>bool</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#88c0d0>Done</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>&lt;-</span><span style=color:#81a1c1;font-weight:700>chan</span> <span style=color:#81a1c1;font-weight:700>struct</span><span style=color:#eceff4>{}</span>
</span></span><span style=display:flex><span>    <span style=color:#88c0d0>Err</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>error</span>
</span></span><span style=display:flex><span>    <span style=color:#88c0d0>Value</span><span style=color:#eceff4>(</span>key <span style=color:#81a1c1>any</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>any</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>Questi corrispondono a tre capacita distinte:</p><ol><li><strong>Cancellazione</strong>: un channel (<code>Done()</code>) che si chiude quando il context viene cancellato. Il lavoro downstream controlla questo e si ferma.</li><li><strong>Deadline e timeout</strong>: un momento nel tempo dopo il quale <code>Done()</code> si chiude automaticamente e <code>Err()</code> restituisce <code>context.DeadlineExceeded</code>.</li><li><strong>Valori request-scoped</strong>: uno store immutabile chiave-valore propagato attraverso la catena di chiamate. Questa e la feature piu abusata.</li></ol><p>Context non e un meccanismo di comunicazione general-purpose. Per quello si usano i channel. Context e il plumbing che permette a un chiamante di dire &ldquo;se cancello o vado in timeout, tutto il downstream deve saperlo.&rdquo;</p><h2 class="relative group">L&rsquo;anti-pattern della chiave di context<div id=lanti-pattern-della-chiave-di-context class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#lanti-pattern-della-chiave-di-context aria-label=Ancora>#</a></span></h2><p>L&rsquo;errore piu comune con <code>context.WithValue</code> e usare un tipo built-in (di solito <code>string</code>) come chiave:</p><div class=highlight-wrapper><div class=codeblock-title>wrong: string key causes collisions</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#616e87;font-style:italic>// SBAGLIATO: qualsiasi package puo leggere o sovrascrivere questa chiave</span>
</span></span><span style=display:flex><span>ctx <span style=color:#eceff4>=</span> context<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithValue</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;userID&#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>42</span><span style=color:#eceff4>)</span></span></span></code></pre></div></div><p>La documentazione di Go e esplicita: le chiavi devono essere tipi comparabili che non sono esportati da nessun package, per evitare collisioni tra package che usano la stessa stringa. Il pattern corretto usa un tipo non esportato:</p><div class=highlight-wrapper><div class=codeblock-title>correct: unexported key type</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// contextKey e un tipo non esportato per le chiavi context in questo package.</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Usare un tipo con nome previene le collisioni con le chiavi di altri package.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> contextKey <span style=color:#81a1c1>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>const</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    userIDKey contextKey <span style=color:#eceff4>=</span> <span style=color:#81a1c1;font-weight:700>iota</span>
</span></span><span style=display:flex><span>    tenantIDKey
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>WithUserID</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> id <span style=color:#81a1c1>int64</span><span style=color:#eceff4>)</span> context<span style=color:#eceff4>.</span>Context <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> context<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithValue</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> userIDKey<span style=color:#eceff4>,</span> id<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>UserID</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>int64</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>bool</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    id<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> ctx<span style=color:#eceff4>.</span><span style=color:#88c0d0>Value</span><span style=color:#eceff4>(</span>userIDKey<span style=color:#eceff4>).(</span><span style=color:#81a1c1>int64</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> id<span style=color:#eceff4>,</span> ok
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>Poiche <code>contextKey</code> e un tipo non esportato, nessun altro package puo accidentalmente leggere o scrivere i tuoi valori. Le funzioni accessor tipizzate forniscono anche un&rsquo;API type-safe invece di disseminare chiamate <code>.Value()</code> e type assertion in tutto il codebase.</p><h2 class="relative group">Cancellazione delle goroutine con select<div id=cancellazione-delle-goroutine-con-select class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cancellazione-delle-goroutine-con-select aria-label=Ancora>#</a></span></h2><p>Il pattern piu importante per il Go in produzione e controllare <code>ctx.Done()</code> nelle goroutine che eseguono lavoro di lunga durata. Se si lancia una goroutine ignorando il context, si ha un goroutine leak in attesa di manifestarsi.</p><div class=highlight-wrapper><div class=codeblock-title>goroutine cancellation</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>processItems</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> items <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>error</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    results <span style=color:#81a1c1>:=</span> <span style=color:#81a1c1>make</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>chan</span> <span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>len</span><span style=color:#eceff4>(</span>items<span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>go</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>()</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>for</span> _<span style=color:#eceff4>,</span> item <span style=color:#81a1c1>:=</span> <span style=color:#81a1c1;font-weight:700>range</span> items <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            results <span style=color:#81a1c1>&lt;-</span> <span style=color:#88c0d0>expensiveTransform</span><span style=color:#eceff4>(</span>item<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>close</span><span style=color:#eceff4>(</span>results<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>var</span> processed <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>for</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>select</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>case</span> <span style=color:#81a1c1>&lt;-</span>ctx<span style=color:#eceff4>.</span><span style=color:#88c0d0>Done</span><span style=color:#eceff4>():</span>
</span></span><span style=display:flex><span>            <span style=color:#616e87;font-style:italic>// Il chiamante ha cancellato o e andato in timeout. Ferma il lavoro e restituisce l&#39;errore.</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span> ctx<span style=color:#eceff4>.</span><span style=color:#88c0d0>Err</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>case</span> result<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> <span style=color:#81a1c1>&lt;-</span>results<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#eceff4>!</span>ok <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                <span style=color:#616e87;font-style:italic>// Channel chiuso: tutti gli elementi elaborati.</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>            processed <span style=color:#eceff4>=</span> <span style=color:#81a1c1>append</span><span style=color:#eceff4>(</span>processed<span style=color:#eceff4>,</span> result<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>L&rsquo;istruzione <code>select</code> mette in gara la cancellazione del context con il channel del lavoro. Quello che si attiva per primo vince. Questo e il pattern che distingue i servizi che gestiscono i picchi di carico in modo elegante da quelli che accumulano goroutine durante i periodi di lentezza.</p><h2 class="relative group">Cancellazione degli HTTP handler<div id=cancellazione-degli-http-handler class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cancellazione-degli-http-handler aria-label=Ancora>#</a></span></h2><p>Quando un client si disconnette a meta richiesta, il package <code>net/http</code> di Go cancella automaticamente <code>r.Context()</code>. Se l&rsquo;handler ignora il context, continua a fare lavoro per un client che non sta piu ascoltando.</p><div class=highlight-wrapper><div class=codeblock-title>http handler with cancellation</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>searchHandler</span><span style=color:#eceff4>(</span>w http<span style=color:#eceff4>.</span>ResponseWriter<span style=color:#eceff4>,</span> r <span style=color:#81a1c1>*</span>http<span style=color:#eceff4>.</span>Request<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    ctx <span style=color:#81a1c1>:=</span> r<span style=color:#eceff4>.</span><span style=color:#88c0d0>Context</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    query <span style=color:#81a1c1>:=</span> r<span style=color:#eceff4>.</span>URL<span style=color:#eceff4>.</span><span style=color:#88c0d0>Query</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;q&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic>// Passa il context della richiesta downstream. Se il client si disconnette,</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic>// ctx.Done() si chiude e la query al database ritorna prima.</span>
</span></span><span style=display:flex><span>    results<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> db<span style=color:#eceff4>.</span><span style=color:#88c0d0>SearchProducts</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> query<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>if</span> errors<span style=color:#eceff4>.</span><span style=color:#88c0d0>Is</span><span style=color:#eceff4>(</span>err<span style=color:#eceff4>,</span> context<span style=color:#eceff4>.</span>Canceled<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#616e87;font-style:italic>// Client disconnesso. Non e necessario scrivere una risposta.</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>        http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;search failed&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusInternalServerError<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    json<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewEncoder</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>).</span><span style=color:#88c0d0>Encode</span><span style=color:#eceff4>(</span>results<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=important><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></div><div class=grow>Importante</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Propaga sempre il context della richiesta da <code>r.Context()</code> in ogni chiamata downstream. Non creare mai un nuovo <code>context.Background()</code> dentro un handler per lavoro che appartiene a quella richiesta.</p></div></div><h2 class="relative group">HTTP client con timeout<div id=http-client-con-timeout class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#http-client-con-timeout aria-label=Ancora>#</a></span></h2><p>Questo e probabilmente il caso d&rsquo;uso piu comune in produzione. Ogni chiamata HTTP in uscita dovrebbe avere un timeout. Senza di esso, un servizio downstream lento puo tenere le goroutine bloccate indefinitamente.</p><div class=highlight-wrapper><div class=codeblock-title>http client with timeout</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>fetchUser</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> userID <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>User<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic>// Imponi una deadline per chiamata indipendentemente dal context padre.</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic>// Il minore tra i due (deadline del padre o 5s) vince.</span>
</span></span><span style=display:flex><span>    ctx<span style=color:#eceff4>,</span> cancel <span style=color:#81a1c1>:=</span> context<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithTimeout</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> <span style=color:#b48ead>5</span><span style=color:#81a1c1>*</span>time<span style=color:#eceff4>.</span>Second<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>defer</span> <span style=color:#88c0d0>cancel</span><span style=color:#eceff4>()</span> <span style=color:#616e87;font-style:italic>// Chiama sempre cancel per rilasciare le risorse.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    req<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> http<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewRequestWithContext</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>MethodGet<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        <span style=color:#a3be8c>&#34;https://api.example.com/users/&#34;</span><span style=color:#81a1c1>+</span>userID<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;building request: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    resp<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> http<span style=color:#eceff4>.</span>DefaultClient<span style=color:#eceff4>.</span><span style=color:#88c0d0>Do</span><span style=color:#eceff4>(</span>req<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;fetching user: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>defer</span> resp<span style=color:#eceff4>.</span>Body<span style=color:#eceff4>.</span><span style=color:#88c0d0>Close</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>var</span> user User
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>:=</span> json<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewDecoder</span><span style=color:#eceff4>(</span>resp<span style=color:#eceff4>.</span>Body<span style=color:#eceff4>).</span><span style=color:#88c0d0>Decode</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&amp;</span>user<span style=color:#eceff4>);</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;decoding response: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1>&amp;</span>user<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Suggerimento</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Usa <code>http.NewRequestWithContext</code> (non il piu vecchio <code>req.WithContext</code>) per tutto il nuovo codice. Imposta il context al momento della costruzione, che e l&rsquo;API piu pulita.</p></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=warning><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></div><div class=grow>Avviso</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Chiama sempre <code>defer cancel()</code> immediatamente dopo <code>context.WithTimeout</code> o <code>context.WithDeadline</code>. Se lo dimentichi, la goroutine del timer interno del context fa un leak fino a quando la deadline non scatta da sola.</p></div></div><h2 class="relative group">Query al database con context<div id=query-al-database-con-context class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#query-al-database-con-context aria-label=Ancora>#</a></span></h2><p>I moderni driver per database (<code>database/sql</code>, <code>pgx</code>, <code>go-redis</code>) accettano tutti il context. Passalo cosi le query in corso vengono cancellate quando la richiesta va in timeout o il client si disconnette.</p><div class=highlight-wrapper><div class=codeblock-title>database with context</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>r <span style=color:#81a1c1>*</span>ProductRepository<span style=color:#eceff4>)</span> <span style=color:#88c0d0>FindByID</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> id <span style=color:#81a1c1>int64</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>Product<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>const</span> query <span style=color:#eceff4>=</span> <span style=color:#a3be8c>`SELECT id, name, price, stock FROM products WHERE id = $1`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>var</span> p Product
</span></span><span style=display:flex><span>    err <span style=color:#81a1c1>:=</span> r<span style=color:#eceff4>.</span>db<span style=color:#eceff4>.</span><span style=color:#88c0d0>QueryRowContext</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> query<span style=color:#eceff4>,</span> id<span style=color:#eceff4>).</span><span style=color:#88c0d0>Scan</span><span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>&amp;</span>p<span style=color:#eceff4>.</span>ID<span style=color:#eceff4>,</span> <span style=color:#81a1c1>&amp;</span>p<span style=color:#eceff4>.</span>Name<span style=color:#eceff4>,</span> <span style=color:#81a1c1>&amp;</span>p<span style=color:#eceff4>.</span>Price<span style=color:#eceff4>,</span> <span style=color:#81a1c1>&amp;</span>p<span style=color:#eceff4>.</span>Stock<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>if</span> errors<span style=color:#eceff4>.</span><span style=color:#88c0d0>Is</span><span style=color:#eceff4>(</span>err<span style=color:#eceff4>,</span> sql<span style=color:#eceff4>.</span>ErrNoRows<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> ErrNotFound
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;querying product %d: %w&#34;</span><span style=color:#eceff4>,</span> id<span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1>&amp;</span>p<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>Quando <code>ctx</code> viene cancellato, <code>QueryRowContext</code> restituisce un errore che wrappa <code>context.Canceled</code>. Questo si propaga risalendo lo stack delle chiamate, e il tuo handler puo decidere se loggarlo o ignorarlo silenziosamente.</p><h2 class="relative group">WithValue: quando usarlo e quando no<div id=withvalue-quando-usarlo-e-quando-no class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#withvalue-quando-usarlo-e-quando-no aria-label=Ancora>#</a></span></h2><p><code>context.WithValue</code> e per metadati request-scoped che attraversano i confini delle API dove aggiungere un parametro alla funzione non e pratico. Esempi che hanno senso:</p><ul><li>Trace ID e request ID per il logging strutturato</li><li>Identita dell&rsquo;utente autenticato impostata dal middleware</li><li>Tenant ID in servizi multi-tenant</li></ul><p>Esempi che non appartengono al context:</p><ul><li>Valori di configurazione (usa una struct di config)</li><li>Istanze di logger (iniettale tramite campi struct)</li><li>Connessioni al database (iniettale tramite dependency injection)</li><li>Parametri di funzione (aggiungi semplicemente il parametro)</li></ul><p>Il test e semplice: se rimuovere il valore dal context richiederebbe di aggiungere un parametro a ogni funzione nella catena, potrebbe appartenerci. Se richiederebbe di aggiungerlo a una sola funzione, non appartiene al context.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Nota</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>I valori del context non sono type-safe per impostazione predefinita e non hanno visibilita nelle firme delle funzioni. Un abuso porta a codice difficile da ragionare. Tratta <code>WithValue</code> come ultima risorsa per le cross-cutting concern, non come un modo per evitare di passare parametri.</p></div></div><h2 class="relative group">Architettura: propagazione del context in una richiesta<div id=architettura-propagazione-del-context-in-una-richiesta class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#architettura-propagazione-del-context-in-una-richiesta aria-label=Ancora>#</a></span></h2><p>Ecco come il context scorre attraverso un tipico servizio a tre livelli:</p><pre class="not-prose mermaid">
flowchart TD
    A[HTTP Request] -->|r.Context| B[Handler]
    B -->|WithTimeout 5s| C[Service Layer]
    C -->|propagate ctx| D[Repository]
    C -->|propagate ctx| E[Downstream HTTP Call]
    D -->|QueryRowContext| F[(Database)]
    E -->|NewRequestWithContext| G[External API]
    B -->|ctx.Done closes on disconnect| H[Cancelled]
    H -->|error bubbles up| C
    H -->|query returns| D
</pre><p>L&rsquo;handler possiede il context radice (da <code>r.Context()</code>). Ogni livello lo passa invariato, oppure lo wrappa con una deadline piu stretta. Quando scatta la cancellazione, il segnale si propaga a ogni chiamata in corso simultaneamente.</p><h2 class="relative group">Errori comuni<div id=errori-comuni class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#errori-comuni aria-label=Ancora>#</a></span></h2><div id=accordion-601e780224aad3afea352957bf7aa80b class="border border-neutral-200 dark:border-neutral-700 rounded-lg overflow-hidden" data-accordion=collapse data-accordion-separated=false><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Usare chiavi string per i valori del context</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Le chiavi string causano collisioni silenziose tra package. Due package che memorizzano entrambi un valore sotto la chiave <code>"userID"</code> si sovrascriveranno a vicenda. Usa sempre un tipo con nome non esportato definito nel tuo package come tipo di chiave.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Passare nil come context</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Alcuni vecchi codici passano <code>nil</code> come argomento context. Questo causa un panic alla prima chiamata al metodo del context. Usa <code>context.Background()</code> come context radice in <code>main</code>, nei test e in qualsiasi posto dove non c&rsquo;e un context padre da cui derivare. Usa <code>context.TODO()</code> come segnaposto quando sai che il context deve essere plumbato ma non l&rsquo;hai ancora fatto.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Ignorare ctx.Done() nelle goroutine</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Lanciare una goroutine senza mai controllare <code>ctx.Done()</code> significa che la goroutine viene eseguita fino al completamento anche quando il chiamante ha cancellato. In un servizio ad alto traffico, questo si accumula come goroutine leak che si manifestano come crescita della memoria e latenza crescente nel tempo.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Creare context.Background() dentro gli handler</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Se crei un context background fresco dentro un HTTP handler per una chiamata in uscita, distacchi quella chiamata dal ciclo di vita della richiesta. Una disconnessione del client o un timeout del server non cancellera piu il lavoro in uscita. Deriva sempre da <code>r.Context()</code>.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Memorizzare il context in una struct</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Il team di Go sconsiglia esplicitamente di memorizzare un <code>context.Context</code> come campo di una struct. I context sono pensati per scorrere attraverso le catene di chiamate, non essere mantenuti come stato. Se ti ritrovi a memorizzarne uno, di solito e il segnale di un problema di design.</div></details></div><style>#accordion-601e780224aad3afea352957bf7aa80b>details+details{border-top:1px solid rgb(var(--color-neutral-200))}.dark #accordion-601e780224aad3afea352957bf7aa80b>details+details{border-top-color:rgb(var(--color-neutral-700))}</style><script>(()=>{const e=document.getElementById("accordion-601e780224aad3afea352957bf7aa80b");if(!e)return;const t=e.querySelectorAll("details[data-accordion-item]");t.forEach(e=>{e.addEventListener("toggle",()=>{if(!e.open)return;t.forEach(t=>{t!==e&&t.removeAttribute("open")})})})})()</script><hr><p>Se vuoi approfondire questi argomenti, offro sessioni di coaching 1:1 per ingegneri che lavorano su integrazione AI, architetture cloud e platform engineering. <a href=https://calendly.com/manuelfedele/60min target=_blank rel=noreferrer>Prenota una sessione</a> (50 EUR / 60 min) o scrivimi a <a href=mailto:manuel.fedele+website@gmail.com>manuel.fedele+website@gmail.com</a>.</p></div><h2 class="mt-8 text-2xl font-extrabold mb-10">Articoli correlati</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1633356122544-f134324a6cee?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/use-protobuf-with-golang/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Protocol Buffers in Go: Serializzazione, gRPC e Performance</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-12-27T18:48:44+01:00>27 dicembre 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">7 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/protobuf/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Protobuf
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/grpc/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Grpc</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1505238680356-667803448bb6?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/create-command-line-application-with-golang/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Costruire CLI in Go con Cobra: flag, sottocomandi e shell completion</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-12-20T10:03:30+01:00>20 dicembre 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">7 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/cli/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cli
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/cobra/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cobra</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1597852074816-d933c7d2b988?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/use-redis-with-golang/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Redis in Go con go-redis/v9: Caching, Pub/Sub e Pattern di Produzione</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-12-19T19:32:27+01:00>19 dicembre 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">10 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/redis/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Redis
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/caching/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Caching
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/pubsub/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Pubsub</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1605810230434-7631ac76ec81?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/create-desktop-application-stock-market-data-golang/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Applicazioni desktop in Go con Fyne: dashboard mercato azionario</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-12-19T19:08:58+01:00>19 dicembre 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">7 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/stock/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Stock
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/fyne/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Fyne
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/desktop/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Desktop</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/it/posts/understand-async-await-in-python/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Python Async/Await in Pratica: asyncio, FastAPI e Insidie Comuni
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-01-01T14:50:35+01:00>1 gennaio 2023</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/it/posts/use-protobuf-with-fastapi/><span class=leading-6>Servire Protocol Buffers con FastAPI: Endpoint Binari e gRPC Gateway&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-01-04T16:00:43+01:00>4 gennaio 2023</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Torna in cima" title="Torna in cima">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Manuel Fedele</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://manuelfedele.github.io/it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Cerca tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Chiudi (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>