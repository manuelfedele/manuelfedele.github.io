<!doctype html><html lang=it dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="it"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>JWT Authentication in Go: HS256, RS256 e Pattern di Middleware &#183; Git Push and Run</title><meta name=title content="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware &#183; Git Push and Run"><meta name=description content="Ingegnere Software e Cloud Architect. Scrivo di Go, Python, AWS e sistemi AI."><meta name=keywords content="golang,security,jwt,authentication,"><link rel=canonical href=https://manuelfedele.github.io/it/posts/jwt-issuer-in-go/><meta name=author content="Manuel Fedele"><link href=https://github.com/manuelfedele rel=me><link href=https://linkedin.com/in/manuel-fedele rel=me><meta property="og:url" content="https://manuelfedele.github.io/it/posts/jwt-issuer-in-go/"><meta property="og:site_name" content="Git Push and Run"><meta property="og:title" content="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware"><meta property="og:description" content="I JWT non sono sessioni. Sono claim firmati e auto-contenuti che non possono essere revocati senza infrastruttura aggiuntiva. Capire questo tradeoff prima di scegliere JWT e’ piu’ importante di qualsiasi dettaglio implementativo. Questo post copre HS256 vs RS256, middleware di validazione corretto, revoca dei token con Redis e un endpoint JWKS per la verifica service-to-service. I JWT sono ampiamente mal utilizzati. I team li usano per default perche’ ogni tutorial li mostra, non perche’ siano lo strumento giusto per il lavoro. Prima di scrivere codice, bisogna capire cosa sono davvero i JWT e cosa non sono."><meta property="og:locale" content="it"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-27T17:18:00+00:00"><meta property="article:modified_time" content="2024-11-27T17:18:00+00:00"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Security"><meta property="article:tag" content="Jwt"><meta property="article:tag" content="Authentication"><meta name=twitter:card content="summary"><meta name=twitter:title content="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware"><meta name=twitter:description content="I JWT non sono sessioni. Sono claim firmati e auto-contenuti che non possono essere revocati senza infrastruttura aggiuntiva. Capire questo tradeoff prima di scegliere JWT e’ piu’ importante di qualsiasi dettaglio implementativo. Questo post copre HS256 vs RS256, middleware di validazione corretto, revoca dei token con Redis e un endpoint JWKS per la verifica service-to-service. I JWT sono ampiamente mal utilizzati. I team li usano per default perche’ ogni tutorial li mostra, non perche’ siano lo strumento giusto per il lavoro. Prima di scrivere codice, bisogna capire cosa sono davvero i JWT e cosa non sono."><link type=text/css rel=stylesheet href=/css/main.bundle.min.726dfbf42bcd66e35e2d7258d72fe8fe77509ff76d153e2b46cdbae9c3af9620653459f0119a72d2af4a9b4bc446652d244ad58743d0290e5d8e09e3983b98e5.css integrity="sha512-cm379CvNZuNeLXJY1y/o/ndQn/dtFT4rRs266cOvliBlNFnwEZpy0q9Km0vERmUtJErVh0PQKQ5djgnjmDuY5Q=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.88278edec77139635e1ad294df5b32b7be9338191c5252d3f6f451ace5852d5f82390cccacedab9c64739d8e068b7e8502895cf8f951060c0368f9a73709fcb7.js integrity="sha512-iCeO3sdxOWNeGtKU31syt76TOBkcUlLT9vRRrOWFLV+COQzMrO2rnGRznY4Gi36FAolc+PlRBgwDaPmnNwn8tw==" data-copy=Copia data-copied=Copiato></script><script defer type=text/javascript src=/js/mermaid.bundle.c63c50c6884d5e5a17085b7ea24a2ef1f2c96af692b3e243dfab2ab9ef6e6c045a111b16d5cd3ce4d3f1a4919e6a86c4d49c16f5cf9b44db6dd7f6ffbc8d4b49.js integrity="sha512-xjxQxohNXloXCFt+okou8fLJavaSs+JD36sque9ubARaERsW1c085NPxpJGeaobE1JwW9c+bRNtt1/b/vI1LSQ=="></script><script src=/js/shortcodes/tabs.min.b9b8a6b2cf6c81163025e44a18c0ccce600efe2dfc29d2d11515fe41b8e1e8e00896759b9e55eab7032ab15d1bec124c32e8996685e563de84ad243eb61ec236.js integrity="sha512-ubimss9sgRYwJeRKGMDMzmAO/i38KdLRFRX+Qbjh6OAIlnWbnlXqtwMqsV0b7BJMMuiZZoXlY96ErSQ+th7CNg==" crossorigin=anonymous></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"JWT Authentication in Go: HS256, RS256 e Pattern di Middleware","headline":"JWT Authentication in Go: HS256, RS256 e Pattern di Middleware","inLanguage":"it","url":"https://manuelfedele.github.io/it/posts/jwt-issuer-in-go/","author":{"@type":"Person","name":"Manuel Fedele"},"copyrightYear":"2024","dateCreated":"2024-11-27T17:18:00\u002b00:00","datePublished":"2024-11-27T17:18:00\u002b00:00","dateModified":"2024-11-27T17:18:00\u002b00:00","keywords":["golang","security","jwt","authentication"],"mainEntityOfPage":"true","wordCount":"2442"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Salta al contenuto principale</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/it/ class="text-base font-medium truncate min-w-0 shrink">Git Push and Run</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/it/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title=Posts><span class="text-base font-medium break-normal">Blog
</span></a><a href=/it/about/ class="flex items-center bf-icon-color-hover" aria-label="Chi sono" title="Chi sono"><span class="text-base font-medium break-normal">Chi sono
</span></a><a href=/it/coaching/ class="flex items-center bf-icon-color-hover" aria-label=Coaching title=Coaching><span class="text-base font-medium break-normal">Coaching
</span></a><a href=https://github.com/manuelfedele target=_blank class="flex items-center bf-icon-color-hover" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware">IT</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/jwt-issuer-in-go/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="JWT Authentication in Go: HS256, RS256, and Middleware Patterns">EN
</span></a><a href=/it/posts/jwt-issuer-in-go/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware">IT</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Cerca (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Cerca (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/it/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Blog</span></a></div><div class=px-2><a href=/it/about/ aria-label="Chi sono" class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title="Chi sono" class="text-2xl font-bold tracking-tight">Chi sono</span></a></div><div class=px-2><a href=/it/coaching/ aria-label=Coaching class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Coaching class="text-2xl font-bold tracking-tight">Coaching</span></a></div><div class=px-2><a href=https://github.com/manuelfedele aria-label=github target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span><span title class="text-2xl font-bold tracking-tight"></span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware">IT</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/jwt-issuer-in-go/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="JWT Authentication in Go: HS256, RS256, and Middleware Patterns">EN
</span></a><a href=/it/posts/jwt-issuer-in-go/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="JWT Authentication in Go: HS256, RS256 e Pattern di Middleware">IT</span></a></li></ul></div></div></nav></div></div></div></div></div><script>(function(){var t,n,e=document.querySelector(".main-menu");if(!e)return;t=window.location.pathname,n=e.querySelectorAll('a[href="'+t+'"]'),n.forEach(function(e){var t=e.querySelectorAll("span");t.forEach(function(e){e.classList.add("active")})})})()</script></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src="https://images.unsplash.com/photo-1614064641938-3bbee52942c7?w=1200&amp;q=85" role=presentation loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-xl bg-neutral-100/75 dark:bg-neutral-800/60"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url="https://images.unsplash.com/photo-1614064641938-3bbee52942c7?w=1200&amp;q=85"></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">JWT Authentication in Go: HS256, RS256 e Pattern di Middleware</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-11-27T17:18:00+00:00>27 novembre 2024</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">12 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/security/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Security
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/jwt/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Jwt
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/authentication/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Authentication</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Indice dei contenuti</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#hs256-vs-rs256>HS256 vs RS256</a></li><li><a href=#hs256-caricamento-corretto-della-chiave-e-validazione>HS256: Caricamento Corretto della Chiave e Validazione</a></li><li><a href=#rs256-coppia-di-chiavi-rsa-firma-e-verifica>RS256: Coppia di Chiavi RSA, Firma e Verifica</a></li><li><a href=#claim-standard-a-cosa-serve-ciascuno>Claim Standard: A Cosa Serve Ciascuno</a></li><li><a href=#middleware-di-validazione-per-nethttp>Middleware di Validazione per net/http</a></li><li><a href=#revoca-dei-token-con-redis>Revoca dei Token con Redis</a></li><li><a href=#endpoint-jwks-rs256>Endpoint JWKS RS256</a></li><li><a href=#errori-comuni>Errori Comuni</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Indice dei contenuti</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#hs256-vs-rs256>HS256 vs RS256</a></li><li><a href=#hs256-caricamento-corretto-della-chiave-e-validazione>HS256: Caricamento Corretto della Chiave e Validazione</a></li><li><a href=#rs256-coppia-di-chiavi-rsa-firma-e-verifica>RS256: Coppia di Chiavi RSA, Firma e Verifica</a></li><li><a href=#claim-standard-a-cosa-serve-ciascuno>Claim Standard: A Cosa Serve Ciascuno</a></li><li><a href=#middleware-di-validazione-per-nethttp>Middleware di Validazione per net/http</a></li><li><a href=#revoca-dei-token-con-redis>Revoca dei Token con Redis</a></li><li><a href=#endpoint-jwks-rs256>Endpoint JWKS RS256</a></li><li><a href=#errori-comuni>Errori Comuni</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><div class="lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl">I JWT non sono sessioni. Sono claim firmati e auto-contenuti che non possono essere revocati senza infrastruttura aggiuntiva. Capire questo tradeoff prima di scegliere JWT e&rsquo; piu&rsquo; importante di qualsiasi dettaglio implementativo. Questo post copre HS256 vs RS256, middleware di validazione corretto, revoca dei token con Redis e un endpoint JWKS per la verifica service-to-service.</div><p>I JWT sono ampiamente mal utilizzati. I team li usano per default perche&rsquo; ogni tutorial li mostra, non perche&rsquo; siano lo strumento giusto per il lavoro. Prima di scrivere codice, bisogna capire cosa sono davvero i JWT e cosa non sono.</p><p>Un JWT e&rsquo; un token firmato contenente claim. La firma permette al titolare di verificare che il token sia stato emesso da qualcuno con la chiave di firma. Non fornisce cifratura (a meno di usare JWE). Non e&rsquo; una sessione: non puoi invalidarlo server-side senza mantenere uno stato, il che vanifica il pitch &ldquo;stateless&rdquo;. Non e&rsquo; intrinsecamente sicuro: l&rsquo;attacco <code>alg: none</code> e HS256 con segreti condivisi tra servizi hanno causato reali incidenti in produzione.</p><p>Per le applicazioni web basate su browser, le sessioni cookie con storage server-side sono spesso la scelta migliore. I JWT brillano nell&rsquo;autenticazione service-to-service e nell&rsquo;accesso alle API dove la statelessness e&rsquo; un requisito di progettazione genuino.</p><h2 class="relative group">HS256 vs RS256<div id=hs256-vs-rs256 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#hs256-vs-rs256 aria-label=Ancora>#</a></span></h2><pre class="not-prose mermaid">
flowchart LR
    subgraph HS256
        A[Service A] -->|segreto condiviso| B[Service B]
        A -->|segreto condiviso| C[Service C]
    end
    subgraph RS256
        I[Issuer\nchiave privata] -->|firma| T[Token]
        T -->|verifica con chiave pubblica| D[Service D]
        T -->|verifica con chiave pubblica| E[Service E]
        I -->|JWKS endpoint| D
        I -->|JWKS endpoint| E
    end
</pre><p><strong>HS256 (HMAC-SHA256)</strong> usa una singola chiave segreta sia per la firma che per la verifica. Qualsiasi servizio che verifica il token deve avere il segreto, il che significa che il segreto deve essere distribuito a tutti i verificatori. La compromissione di qualsiasi servizio compromette la capacita&rsquo; di firma.</p><p><strong>RS256 (RSA-SHA256)</strong> usa una coppia di chiavi asimmetrica. L&rsquo;emittente firma con la chiave privata; i verificatori hanno bisogno solo della chiave pubblica. La chiave privata non lascia mai l&rsquo;emittente. Puoi pubblicare la chiave pubblica su un endpoint JWKS e permettere agli altri servizi di recuperarla.</p><div class="tab__container w-full"><div class=tab__nav role=tablist><div class="flex flex-wrap gap-1"><button class="tab__button px-3 py-2 text-sm font-semibold border-b-2 border-transparent rounded-t-md hover:bg-neutral-200 dark:hover:bg-neutral-700 tab--active" role=tab aria-selected=true data-tab-index=0 data-tab-label>
<span class="flex items-center gap-1"></span></button><button class="tab__button px-3 py-2 text-sm font-semibold border-b-2 border-transparent rounded-t-md hover:bg-neutral-200 dark:hover:bg-neutral-700" role=tab aria-selected=false data-tab-index=1 data-tab-label>
<span class="flex items-center gap-1"></span></button></div></div><div class="tab__content mt-4"><div class="tab__panel tab--active" data-tab-index=0><ul><li>Autenticazione a servizio singolo dove l&rsquo;emittente e il verificatore sono lo stesso servizio.</li><li>Monolite interno o API gateway che emette e valida token.</li><li>Il segreto e&rsquo; memorizzato in un secrets manager (non hardcoded o in variabili d&rsquo;ambiente).</li></ul><p>Non usare mai HS256 quando piu&rsquo; servizi distinti devono verificare i token.</p></div><div class=tab__panel data-tab-index=1><ul><li>Piu&rsquo; servizi indipendenti devono verificare i token senza condividere un segreto.</li><li>Gestisci un authorization server (OAuth2, OIDC) che emette token a terze parti.</li><li>Vuoi un endpoint JWKS pubblico cosi&rsquo; i verificatori possono ruotare le chiavi pubbliche automaticamente.</li><li>I requisiti di conformita&rsquo; richiedono non-ripudio (solo il titolare della chiave privata potrebbe aver firmato).</li></ul></div></div></div><h2 class="relative group">HS256: Caricamento Corretto della Chiave e Validazione<div id=hs256-caricamento-corretto-della-chiave-e-validazione class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#hs256-caricamento-corretto-della-chiave-e-validazione aria-label=Ancora>#</a></span></h2><div class=highlight-wrapper><div class=codeblock-title>internal/auth/hs256.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/golang-jwt/jwt/v5&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/google/uuid&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Claims contiene il nostro payload personalizzato insieme ai registered claim standard.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> Claims <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    UserID <span style=color:#81a1c1>string</span>   <span style=color:#a3be8c>`json:&#34;uid&#34;`</span>
</span></span><span style=display:flex><span>    Roles  <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;roles&#34;`</span>
</span></span><span style=display:flex><span>    jwt<span style=color:#eceff4>.</span>RegisteredClaims
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> HS256Issuer <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    secret   <span style=color:#eceff4>[]</span><span style=color:#81a1c1>byte</span>
</span></span><span style=display:flex><span>    issuer   <span style=color:#81a1c1>string</span>
</span></span><span style=display:flex><span>    audience <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span>
</span></span><span style=display:flex><span>    ttl      time<span style=color:#eceff4>.</span>Duration
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// NewHS256Issuer carica il segreto da una variabile d&#39;ambiente.</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Non accettare mai il segreto come argomento stringa da un chiamante -- invita all&#39;hardcoding.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>NewHS256Issuer</span><span style=color:#eceff4>(</span>envVar<span style=color:#eceff4>,</span> issuer <span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> audience <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> ttl time<span style=color:#eceff4>.</span>Duration<span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>HS256Issuer<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    secret <span style=color:#81a1c1>:=</span> os<span style=color:#eceff4>.</span><span style=color:#88c0d0>Getenv</span><span style=color:#eceff4>(</span>envVar<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#81a1c1>len</span><span style=color:#eceff4>(</span>secret<span style=color:#eceff4>)</span> <span style=color:#eceff4>&lt;</span> <span style=color:#b48ead>32</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;la variabile d&#39;ambiente %q deve essere lunga almeno 32 byte per HS256&#34;</span><span style=color:#eceff4>,</span> envVar<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1>&amp;</span>HS256Issuer<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        secret<span style=color:#eceff4>:</span>   <span style=color:#eceff4>[]</span><span style=color:#81a1c1>byte</span><span style=color:#eceff4>(</span>secret<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>        issuer<span style=color:#eceff4>:</span>   issuer<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        audience<span style=color:#eceff4>:</span> audience<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        ttl<span style=color:#eceff4>:</span>      ttl<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>},</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>i <span style=color:#81a1c1>*</span>HS256Issuer<span style=color:#eceff4>)</span> <span style=color:#88c0d0>Issue</span><span style=color:#eceff4>(</span>userID <span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> roles <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    now <span style=color:#81a1c1>:=</span> time<span style=color:#eceff4>.</span><span style=color:#88c0d0>Now</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    claims <span style=color:#81a1c1>:=</span> Claims<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        UserID<span style=color:#eceff4>:</span> userID<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        Roles<span style=color:#eceff4>:</span>  roles<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        RegisteredClaims<span style=color:#eceff4>:</span> jwt<span style=color:#eceff4>.</span>RegisteredClaims<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            ID<span style=color:#eceff4>:</span>        uuid<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewString</span><span style=color:#eceff4>(),</span> <span style=color:#616e87;font-style:italic>// jti: univoco per token, usato per la revoca</span>
</span></span><span style=display:flex><span>            Issuer<span style=color:#eceff4>:</span>    i<span style=color:#eceff4>.</span>issuer<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>            Audience<span style=color:#eceff4>:</span>  i<span style=color:#eceff4>.</span>audience<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>            Subject<span style=color:#eceff4>:</span>   userID<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>            IssuedAt<span style=color:#eceff4>:</span>  jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewNumericDate</span><span style=color:#eceff4>(</span>now<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>            NotBefore<span style=color:#eceff4>:</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewNumericDate</span><span style=color:#eceff4>(</span>now<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>            ExpiresAt<span style=color:#eceff4>:</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewNumericDate</span><span style=color:#eceff4>(</span>now<span style=color:#eceff4>.</span><span style=color:#88c0d0>Add</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>ttl<span style=color:#eceff4>)),</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>},</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    token <span style=color:#81a1c1>:=</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewWithClaims</span><span style=color:#eceff4>(</span>jwt<span style=color:#eceff4>.</span>SigningMethodHS256<span style=color:#eceff4>,</span> claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> token<span style=color:#eceff4>.</span><span style=color:#88c0d0>SignedString</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>secret<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>i <span style=color:#81a1c1>*</span>HS256Issuer<span style=color:#eceff4>)</span> <span style=color:#88c0d0>Validate</span><span style=color:#eceff4>(</span>tokenString <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    token<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>ParseWithClaims</span><span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>        tokenString<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>&amp;</span>Claims<span style=color:#eceff4>{},</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>t <span style=color:#81a1c1>*</span>jwt<span style=color:#eceff4>.</span>Token<span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>interface</span><span style=color:#eceff4>{},</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#616e87;font-style:italic>// Controlla sempre l&#39;algoritmo. Un attaccante puo&#39; creare un token con</span>
</span></span><span style=display:flex><span>            <span style=color:#616e87;font-style:italic>// alg: none o alg: RS256 e passare la chiave pubblica come segreto HMAC.</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> _<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> t<span style=color:#eceff4>.</span>Method<span style=color:#eceff4>.(</span><span style=color:#81a1c1>*</span>jwt<span style=color:#eceff4>.</span>SigningMethodHMAC<span style=color:#eceff4>);</span> <span style=color:#eceff4>!</span>ok <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;metodo di firma inatteso: %v&#34;</span><span style=color:#eceff4>,</span> t<span style=color:#eceff4>.</span>Header<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#34;alg&#34;</span><span style=color:#eceff4>])</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span> i<span style=color:#eceff4>.</span>secret<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>},</span>
</span></span><span style=display:flex><span>        jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithIssuer</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>issuer<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>        jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithAudience</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>audience<span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>]),</span>
</span></span><span style=display:flex><span>        jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithExpirationRequired</span><span style=color:#eceff4>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;validate token: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    claims<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> token<span style=color:#eceff4>.</span>Claims<span style=color:#eceff4>.(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#eceff4>!</span>ok <span style=color:#81a1c1>||</span> <span style=color:#eceff4>!</span>token<span style=color:#eceff4>.</span>Valid <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> errors<span style=color:#eceff4>.</span><span style=color:#88c0d0>New</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;claim del token non validi&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> claims<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=warning><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></div><div class=grow>Avviso</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Il controllo dell&rsquo;algoritmo nella <code>Keyfunc</code> non e&rsquo; opzionale. La vulnerabilita&rsquo; <code>alg: none</code> permette a un attaccante di rimuovere completamente la firma e costruire un payload arbitrario che alcune implementazioni accettano. L&rsquo;opzione <code>jwt.WithExpirationRequired()</code> garantisce che i token senza claim <code>exp</code> vengano rifiutati.</p></div></div><h2 class="relative group">RS256: Coppia di Chiavi RSA, Firma e Verifica<div id=rs256-coppia-di-chiavi-rsa-firma-e-verifica class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#rs256-coppia-di-chiavi-rsa-firma-e-verifica aria-label=Ancora>#</a></span></h2><div class=highlight-wrapper><div class=codeblock-title>internal/auth/rs256.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;crypto/rand&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;crypto/rsa&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;crypto/x509&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;encoding/pem&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;os&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/golang-jwt/jwt/v5&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/google/uuid&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// GenerateRSAKeyPair genera una coppia di chiavi RSA a 2048 bit e scrive i file PEM.</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Eseguilo una volta durante il setup; memorizza la chiave privata in un secrets manager.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>GenerateRSAKeyPair</span><span style=color:#eceff4>(</span>privateKeyPath<span style=color:#eceff4>,</span> publicKeyPath <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>error</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    privateKey<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> rsa<span style=color:#eceff4>.</span><span style=color:#88c0d0>GenerateKey</span><span style=color:#eceff4>(</span>rand<span style=color:#eceff4>.</span>Reader<span style=color:#eceff4>,</span> <span style=color:#b48ead>2048</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;generate rsa key: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    privPEM <span style=color:#81a1c1>:=</span> pem<span style=color:#eceff4>.</span><span style=color:#88c0d0>EncodeToMemory</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&amp;</span>pem<span style=color:#eceff4>.</span>Block<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        Type<span style=color:#eceff4>:</span>  <span style=color:#a3be8c>&#34;RSA PRIVATE KEY&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        Bytes<span style=color:#eceff4>:</span> x509<span style=color:#eceff4>.</span><span style=color:#88c0d0>MarshalPKCS1PrivateKey</span><span style=color:#eceff4>(</span>privateKey<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>:=</span> os<span style=color:#eceff4>.</span><span style=color:#88c0d0>WriteFile</span><span style=color:#eceff4>(</span>privateKeyPath<span style=color:#eceff4>,</span> privPEM<span style=color:#eceff4>,</span> <span style=color:#b48ead>0600</span><span style=color:#eceff4>);</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;write private key: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pubDER<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> x509<span style=color:#eceff4>.</span><span style=color:#88c0d0>MarshalPKIXPublicKey</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&amp;</span>privateKey<span style=color:#eceff4>.</span>PublicKey<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;marshal public key: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    pubPEM <span style=color:#81a1c1>:=</span> pem<span style=color:#eceff4>.</span><span style=color:#88c0d0>EncodeToMemory</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&amp;</span>pem<span style=color:#eceff4>.</span>Block<span style=color:#eceff4>{</span>Type<span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;PUBLIC KEY&#34;</span><span style=color:#eceff4>,</span> Bytes<span style=color:#eceff4>:</span> pubDER<span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> os<span style=color:#eceff4>.</span><span style=color:#88c0d0>WriteFile</span><span style=color:#eceff4>(</span>publicKeyPath<span style=color:#eceff4>,</span> pubPEM<span style=color:#eceff4>,</span> <span style=color:#b48ead>0644</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> RS256Issuer <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    privateKey <span style=color:#81a1c1>*</span>rsa<span style=color:#eceff4>.</span>PrivateKey
</span></span><span style=display:flex><span>    publicKey  <span style=color:#81a1c1>*</span>rsa<span style=color:#eceff4>.</span>PublicKey
</span></span><span style=display:flex><span>    keyID      <span style=color:#81a1c1>string</span> <span style=color:#616e87;font-style:italic>// claim kid, usato nel JWKS</span>
</span></span><span style=display:flex><span>    issuer     <span style=color:#81a1c1>string</span>
</span></span><span style=display:flex><span>    ttl        time<span style=color:#eceff4>.</span>Duration
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>NewRS256Issuer</span><span style=color:#eceff4>(</span>privateKeyPath<span style=color:#eceff4>,</span> keyID<span style=color:#eceff4>,</span> issuer <span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> ttl time<span style=color:#eceff4>.</span>Duration<span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>RS256Issuer<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    pemData<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> os<span style=color:#eceff4>.</span><span style=color:#88c0d0>ReadFile</span><span style=color:#eceff4>(</span>privateKeyPath<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;read private key: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    block<span style=color:#eceff4>,</span> _ <span style=color:#81a1c1>:=</span> pem<span style=color:#eceff4>.</span><span style=color:#88c0d0>Decode</span><span style=color:#eceff4>(</span>pemData<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> block <span style=color:#81a1c1>==</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;impossibile decodificare il blocco PEM&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    privateKey<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> x509<span style=color:#eceff4>.</span><span style=color:#88c0d0>ParsePKCS1PrivateKey</span><span style=color:#eceff4>(</span>block<span style=color:#eceff4>.</span>Bytes<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;parse private key: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1>&amp;</span>RS256Issuer<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        privateKey<span style=color:#eceff4>:</span> privateKey<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        publicKey<span style=color:#eceff4>:</span>  <span style=color:#81a1c1>&amp;</span>privateKey<span style=color:#eceff4>.</span>PublicKey<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        keyID<span style=color:#eceff4>:</span>      keyID<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        issuer<span style=color:#eceff4>:</span>     issuer<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        ttl<span style=color:#eceff4>:</span>        ttl<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>},</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>i <span style=color:#81a1c1>*</span>RS256Issuer<span style=color:#eceff4>)</span> <span style=color:#88c0d0>Issue</span><span style=color:#eceff4>(</span>userID <span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> roles <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    now <span style=color:#81a1c1>:=</span> time<span style=color:#eceff4>.</span><span style=color:#88c0d0>Now</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    claims <span style=color:#81a1c1>:=</span> Claims<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        UserID<span style=color:#eceff4>:</span> userID<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        Roles<span style=color:#eceff4>:</span>  roles<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        RegisteredClaims<span style=color:#eceff4>:</span> jwt<span style=color:#eceff4>.</span>RegisteredClaims<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            ID<span style=color:#eceff4>:</span>        uuid<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewString</span><span style=color:#eceff4>(),</span>
</span></span><span style=display:flex><span>            Issuer<span style=color:#eceff4>:</span>    i<span style=color:#eceff4>.</span>issuer<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>            Subject<span style=color:#eceff4>:</span>   userID<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>            IssuedAt<span style=color:#eceff4>:</span>  jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewNumericDate</span><span style=color:#eceff4>(</span>now<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>            NotBefore<span style=color:#eceff4>:</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewNumericDate</span><span style=color:#eceff4>(</span>now<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>            ExpiresAt<span style=color:#eceff4>:</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewNumericDate</span><span style=color:#eceff4>(</span>now<span style=color:#eceff4>.</span><span style=color:#88c0d0>Add</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>ttl<span style=color:#eceff4>)),</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>},</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    token <span style=color:#81a1c1>:=</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewWithClaims</span><span style=color:#eceff4>(</span>jwt<span style=color:#eceff4>.</span>SigningMethodRS256<span style=color:#eceff4>,</span> claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    token<span style=color:#eceff4>.</span>Header<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#34;kid&#34;</span><span style=color:#eceff4>]</span> <span style=color:#eceff4>=</span> i<span style=color:#eceff4>.</span>keyID <span style=color:#616e87;font-style:italic>// includi il key ID per la ricerca nel JWKS</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> token<span style=color:#eceff4>.</span><span style=color:#88c0d0>SignedString</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>privateKey<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>i <span style=color:#81a1c1>*</span>RS256Issuer<span style=color:#eceff4>)</span> <span style=color:#88c0d0>Validate</span><span style=color:#eceff4>(</span>tokenString <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    token<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>ParseWithClaims</span><span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>        tokenString<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>&amp;</span>Claims<span style=color:#eceff4>{},</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>t <span style=color:#81a1c1>*</span>jwt<span style=color:#eceff4>.</span>Token<span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>interface</span><span style=color:#eceff4>{},</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> _<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> t<span style=color:#eceff4>.</span>Method<span style=color:#eceff4>.(</span><span style=color:#81a1c1>*</span>jwt<span style=color:#eceff4>.</span>SigningMethodRSA<span style=color:#eceff4>);</span> <span style=color:#eceff4>!</span>ok <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;metodo di firma inatteso: %v&#34;</span><span style=color:#eceff4>,</span> t<span style=color:#eceff4>.</span>Header<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#34;alg&#34;</span><span style=color:#eceff4>])</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span> i<span style=color:#eceff4>.</span>publicKey<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>},</span>
</span></span><span style=display:flex><span>        jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithIssuer</span><span style=color:#eceff4>(</span>i<span style=color:#eceff4>.</span>issuer<span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>        jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithExpirationRequired</span><span style=color:#eceff4>(),</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;validate rs256 token: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    claims<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> token<span style=color:#eceff4>.</span>Claims<span style=color:#eceff4>.(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#eceff4>!</span>ok <span style=color:#81a1c1>||</span> <span style=color:#eceff4>!</span>token<span style=color:#eceff4>.</span>Valid <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;claim del token non validi&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> claims<span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><h2 class="relative group">Claim Standard: A Cosa Serve Ciascuno<div id=claim-standard-a-cosa-serve-ciascuno class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#claim-standard-a-cosa-serve-ciascuno aria-label=Ancora>#</a></span></h2><table><thead><tr><th>Claim</th><th>Nome</th><th>Scopo</th></tr></thead><tbody><tr><td><code>iss</code></td><td>Issuer</td><td>Chi ha emesso il token. Validalo per prevenire attacchi di sostituzione token.</td></tr><tr><td><code>sub</code></td><td>Subject</td><td>Il principal che il token rappresenta (di solito l&rsquo;ID utente).</td></tr><tr><td><code>aud</code></td><td>Audience</td><td>Per quale servizio e&rsquo; destinato il token. Valida per prevenire il riutilizzo tra servizi.</td></tr><tr><td><code>exp</code></td><td>Expiration</td><td>Timestamp Unix dopo il quale il token non e&rsquo; valido. Impostalo sempre.</td></tr><tr><td><code>iat</code></td><td>Issued At</td><td>Quando e&rsquo; stato emesso il token. Utile per rilevare token emessi prima di una rotazione della chiave.</td></tr><tr><td><code>jti</code></td><td>JWT ID</td><td>Identificatore univoco per token. Necessario per la revoca (blocklist per JTI).</td></tr></tbody></table><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=important><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></div><div class=grow>Importante</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Il claim <code>aud</code> e&rsquo; critico nelle architetture multi-servizio. Se il servizio A e il servizio B usano entrambi lo stesso issuer, un token emesso per il servizio A non deve essere accettato dal servizio B. Valida il claim <code>aud</code> ad ogni verifica.</p></div></div><h2 class="relative group">Middleware di Validazione per net/http<div id=middleware-di-validazione-per-nethttp class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#middleware-di-validazione-per-nethttp aria-label=Ancora>#</a></span></h2><div class=highlight-wrapper><div class=codeblock-title>internal/auth/middleware.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;strings&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> contextKey <span style=color:#81a1c1>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>const</span> claimsKey contextKey <span style=color:#eceff4>=</span> <span style=color:#a3be8c>&#34;jwt_claims&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Validator e&#39; implementato sia da HS256Issuer che da RS256Issuer.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> Validator <span style=color:#81a1c1;font-weight:700>interface</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#88c0d0>Validate</span><span style=color:#eceff4>(</span>tokenString <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Middleware estrae il token Bearer, lo valida e inietta i claim nel context.</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// In caso di fallimento restituisce 401 e non chiama il prossimo handler.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>Middleware</span><span style=color:#eceff4>(</span>v Validator<span style=color:#eceff4>)</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>http<span style=color:#eceff4>.</span>Handler<span style=color:#eceff4>)</span> http<span style=color:#eceff4>.</span>Handler <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>next http<span style=color:#eceff4>.</span>Handler<span style=color:#eceff4>)</span> http<span style=color:#eceff4>.</span>Handler <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> http<span style=color:#eceff4>.</span><span style=color:#88c0d0>HandlerFunc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>w http<span style=color:#eceff4>.</span>ResponseWriter<span style=color:#eceff4>,</span> r <span style=color:#81a1c1>*</span>http<span style=color:#eceff4>.</span>Request<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            authHeader <span style=color:#81a1c1>:=</span> r<span style=color:#eceff4>.</span>Header<span style=color:#eceff4>.</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;Authorization&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> authHeader <span style=color:#81a1c1>==</span> <span style=color:#a3be8c>&#34;&#34;</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;Authorization header mancante&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusUnauthorized<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            parts <span style=color:#81a1c1>:=</span> strings<span style=color:#eceff4>.</span><span style=color:#88c0d0>SplitN</span><span style=color:#eceff4>(</span>authHeader<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34; &#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>2</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#81a1c1>len</span><span style=color:#eceff4>(</span>parts<span style=color:#eceff4>)</span> <span style=color:#81a1c1>!=</span> <span style=color:#b48ead>2</span> <span style=color:#81a1c1>||</span> <span style=color:#eceff4>!</span>strings<span style=color:#eceff4>.</span><span style=color:#88c0d0>EqualFold</span><span style=color:#eceff4>(</span>parts<span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>],</span> <span style=color:#a3be8c>&#34;Bearer&#34;</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;formato Authorization header non valido&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusUnauthorized<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            claims<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> v<span style=color:#eceff4>.</span><span style=color:#88c0d0>Validate</span><span style=color:#eceff4>(</span>parts<span style=color:#eceff4>[</span><span style=color:#b48ead>1</span><span style=color:#eceff4>])</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                <span style=color:#616e87;font-style:italic>// Non divulgare i dettagli dell&#39;errore di validazione al client.</span>
</span></span><span style=display:flex><span>                http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;unauthorized&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusUnauthorized<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ctx <span style=color:#81a1c1>:=</span> context<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithValue</span><span style=color:#eceff4>(</span>r<span style=color:#eceff4>.</span><span style=color:#88c0d0>Context</span><span style=color:#eceff4>(),</span> claimsKey<span style=color:#eceff4>,</span> claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            next<span style=color:#eceff4>.</span><span style=color:#88c0d0>ServeHTTP</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> r<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithContext</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// ClaimsFromContext recupera i claim validati dal context della richiesta.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>ClaimsFromContext</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>,</span> <span style=color:#81a1c1>bool</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    claims<span style=color:#eceff4>,</span> ok <span style=color:#81a1c1>:=</span> ctx<span style=color:#eceff4>.</span><span style=color:#88c0d0>Value</span><span style=color:#eceff4>(</span>claimsKey<span style=color:#eceff4>).(</span><span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> claims<span style=color:#eceff4>,</span> ok
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>Utilizzo con il mux standard <code>net/http</code>:</p><div class=highlight-wrapper><div class=codeblock-title>cmd/server/main.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;yourmodule/internal/auth&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>main</span><span style=color:#eceff4>()</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    issuer<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> auth<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewHS256Issuer</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;JWT_SECRET&#34;</span><span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;auth-service&#34;</span><span style=color:#eceff4>,</span> <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;api&#34;</span><span style=color:#eceff4>},</span> time<span style=color:#eceff4>.</span>Hour<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>panic</span><span style=color:#eceff4>(</span>err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mux <span style=color:#81a1c1>:=</span> http<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewServeMux</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic>// Endpoint pubblico: emette token dopo la verifica delle credenziali.</span>
</span></span><span style=display:flex><span>    mux<span style=color:#eceff4>.</span><span style=color:#88c0d0>HandleFunc</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;POST /auth/token&#34;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>w http<span style=color:#eceff4>.</span>ResponseWriter<span style=color:#eceff4>,</span> r <span style=color:#81a1c1>*</span>http<span style=color:#eceff4>.</span>Request<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#616e87;font-style:italic>// Verifica credenziali... (omesso)</span>
</span></span><span style=display:flex><span>        token<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> issuer<span style=color:#eceff4>.</span><span style=color:#88c0d0>Issue</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;user-123&#34;</span><span style=color:#eceff4>,</span> <span style=color:#eceff4>[]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;reader&#34;</span><span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;errore interno&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusInternalServerError<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>        json<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewEncoder</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>).</span><span style=color:#88c0d0>Encode</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>map</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;token&#34;</span><span style=color:#eceff4>:</span> token<span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic>// Endpoint protetto: il middleware valida il token.</span>
</span></span><span style=display:flex><span>    protected <span style=color:#81a1c1>:=</span> http<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewServeMux</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    protected<span style=color:#eceff4>.</span><span style=color:#88c0d0>HandleFunc</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;GET /api/profile&#34;</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>w http<span style=color:#eceff4>.</span>ResponseWriter<span style=color:#eceff4>,</span> r <span style=color:#81a1c1>*</span>http<span style=color:#eceff4>.</span>Request<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        claims<span style=color:#eceff4>,</span> _ <span style=color:#81a1c1>:=</span> auth<span style=color:#eceff4>.</span><span style=color:#88c0d0>ClaimsFromContext</span><span style=color:#eceff4>(</span>r<span style=color:#eceff4>.</span><span style=color:#88c0d0>Context</span><span style=color:#eceff4>())</span>
</span></span><span style=display:flex><span>        json<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewEncoder</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>).</span><span style=color:#88c0d0>Encode</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>map</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;user_id&#34;</span><span style=color:#eceff4>:</span> claims<span style=color:#eceff4>.</span>UserID<span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mux<span style=color:#eceff4>.</span><span style=color:#88c0d0>Handle</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;/api/&#34;</span><span style=color:#eceff4>,</span> auth<span style=color:#eceff4>.</span><span style=color:#88c0d0>Middleware</span><span style=color:#eceff4>(</span>issuer<span style=color:#eceff4>)(</span>protected<span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    http<span style=color:#eceff4>.</span><span style=color:#88c0d0>ListenAndServe</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;:8080&#34;</span><span style=color:#eceff4>,</span> mux<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><h2 class="relative group">Revoca dei Token con Redis<div id=revoca-dei-token-con-redis class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#revoca-dei-token-con-redis aria-label=Ancora>#</a></span></h2><p>I JWT sono stateless per design; la revoca richiede l&rsquo;aggiunta di stato. L&rsquo;approccio standard e&rsquo; una JTI blocklist: memorizza il <code>jti</code> dei token revocati in Redis con un TTL corrispondente all&rsquo;<code>exp</code> del token. I token scadono da Redis automaticamente quando sarebbero comunque scaduti.</p><div class=highlight-wrapper><div class=codeblock-title>internal/auth/revocation.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/redis/go-redis/v9&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> Blocklist <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    rdb <span style=color:#81a1c1>*</span>redis<span style=color:#eceff4>.</span>Client
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>NewBlocklist</span><span style=color:#eceff4>(</span>rdb <span style=color:#81a1c1>*</span>redis<span style=color:#eceff4>.</span>Client<span style=color:#eceff4>)</span> <span style=color:#81a1c1>*</span>Blocklist <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1>&amp;</span>Blocklist<span style=color:#eceff4>{</span>rdb<span style=color:#eceff4>:</span> rdb<span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Revoke aggiunge il JTI di un token alla blocklist fino alla sua scadenza.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>b <span style=color:#81a1c1>*</span>Blocklist<span style=color:#eceff4>)</span> <span style=color:#88c0d0>Revoke</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> claims <span style=color:#81a1c1>*</span>Claims<span style=color:#eceff4>)</span> <span style=color:#81a1c1>error</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    ttl <span style=color:#81a1c1>:=</span> time<span style=color:#eceff4>.</span><span style=color:#88c0d0>Until</span><span style=color:#eceff4>(</span>claims<span style=color:#eceff4>.</span>ExpiresAt<span style=color:#eceff4>.</span>Time<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> ttl <span style=color:#81a1c1>&lt;=</span> <span style=color:#b48ead>0</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#616e87;font-style:italic>// gia&#39; scaduto, non necessario memorizzarlo</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    key <span style=color:#81a1c1>:=</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Sprintf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;blocklist:jti:%s&#34;</span><span style=color:#eceff4>,</span> claims<span style=color:#eceff4>.</span>ID<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> b<span style=color:#eceff4>.</span>rdb<span style=color:#eceff4>.</span><span style=color:#88c0d0>Set</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> key<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;1&#34;</span><span style=color:#eceff4>,</span> ttl<span style=color:#eceff4>).</span><span style=color:#88c0d0>Err</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// IsRevoked restituisce true se il JTI e&#39; nella blocklist.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>b <span style=color:#81a1c1>*</span>Blocklist<span style=color:#eceff4>)</span> <span style=color:#88c0d0>IsRevoked</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> jti <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>bool</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    exists<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> b<span style=color:#eceff4>.</span>rdb<span style=color:#eceff4>.</span><span style=color:#88c0d0>Exists</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Sprintf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;blocklist:jti:%s&#34;</span><span style=color:#eceff4>,</span> jti<span style=color:#eceff4>)).</span><span style=color:#88c0d0>Result</span><span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>false</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;blocklist check: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> exists <span style=color:#eceff4>&gt;</span> <span style=color:#b48ead>0</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>Estendi il middleware per controllare la blocklist:</p><div class=highlight-wrapper><div class=codeblock-title>internal/auth/middleware_with_revocation.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;strings&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>MiddlewareWithRevocation</span><span style=color:#eceff4>(</span>v Validator<span style=color:#eceff4>,</span> bl <span style=color:#81a1c1>*</span>Blocklist<span style=color:#eceff4>)</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>http<span style=color:#eceff4>.</span>Handler<span style=color:#eceff4>)</span> http<span style=color:#eceff4>.</span>Handler <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>next http<span style=color:#eceff4>.</span>Handler<span style=color:#eceff4>)</span> http<span style=color:#eceff4>.</span>Handler <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> http<span style=color:#eceff4>.</span><span style=color:#88c0d0>HandlerFunc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>w http<span style=color:#eceff4>.</span>ResponseWriter<span style=color:#eceff4>,</span> r <span style=color:#81a1c1>*</span>http<span style=color:#eceff4>.</span>Request<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            authHeader <span style=color:#81a1c1>:=</span> r<span style=color:#eceff4>.</span>Header<span style=color:#eceff4>.</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;Authorization&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            parts <span style=color:#81a1c1>:=</span> strings<span style=color:#eceff4>.</span><span style=color:#88c0d0>SplitN</span><span style=color:#eceff4>(</span>authHeader<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34; &#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>2</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#81a1c1>len</span><span style=color:#eceff4>(</span>parts<span style=color:#eceff4>)</span> <span style=color:#81a1c1>!=</span> <span style=color:#b48ead>2</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;unauthorized&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusUnauthorized<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            claims<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> v<span style=color:#eceff4>.</span><span style=color:#88c0d0>Validate</span><span style=color:#eceff4>(</span>parts<span style=color:#eceff4>[</span><span style=color:#b48ead>1</span><span style=color:#eceff4>])</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;unauthorized&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusUnauthorized<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            revoked<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> bl<span style=color:#eceff4>.</span><span style=color:#88c0d0>IsRevoked</span><span style=color:#eceff4>(</span>r<span style=color:#eceff4>.</span><span style=color:#88c0d0>Context</span><span style=color:#eceff4>(),</span> claims<span style=color:#eceff4>.</span>ID<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#81a1c1>||</span> revoked <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                http<span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;unauthorized&#34;</span><span style=color:#eceff4>,</span> http<span style=color:#eceff4>.</span>StatusUnauthorized<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ctx <span style=color:#81a1c1>:=</span> context<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithValue</span><span style=color:#eceff4>(</span>r<span style=color:#eceff4>.</span><span style=color:#88c0d0>Context</span><span style=color:#eceff4>(),</span> claimsKey<span style=color:#eceff4>,</span> claims<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>            next<span style=color:#eceff4>.</span><span style=color:#88c0d0>ServeHTTP</span><span style=color:#eceff4>(</span>w<span style=color:#eceff4>,</span> r<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithContext</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>})</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Nota</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Il controllo della blocklist aggiunge un round-trip Redis per richiesta. Per API ad alto traffico, considera un bloom filter in-memory locale come controllo di primo livello, ricorrendo a Redis solo per i potenziali positivi. Questo riduce il carico su Redis al costo di un piccolo tasso di falsi positivi (che portano sempre a un controllo Redis completo, non a una revoca falsa).</p></div></div><h2 class="relative group">Endpoint JWKS RS256<div id=endpoint-jwks-rs256 class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#endpoint-jwks-rs256 aria-label=Ancora>#</a></span></h2><p>Un endpoint JWKS (JSON Web Key Set) permette agli altri servizi di recuperare la chiave pubblica senza distribuzione manuale. Questo e&rsquo; il pattern standard in OAuth2 e OIDC.</p><div class=highlight-wrapper><div class=codeblock-title>internal/auth/jwks.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;crypto/rsa&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;encoding/base64&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;math/big&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> jwk <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    Kty <span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;kty&#34;`</span>
</span></span><span style=display:flex><span>    Use <span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;use&#34;`</span>
</span></span><span style=display:flex><span>    Kid <span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;kid&#34;`</span>
</span></span><span style=display:flex><span>    Alg <span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;alg&#34;`</span>
</span></span><span style=display:flex><span>    N   <span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;n&#34;`</span> <span style=color:#616e87;font-style:italic>// modulo codificato in base64url</span>
</span></span><span style=display:flex><span>    E   <span style=color:#81a1c1>string</span> <span style=color:#a3be8c>`json:&#34;e&#34;`</span> <span style=color:#616e87;font-style:italic>// esponente codificato in base64url</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> jwks <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    Keys <span style=color:#eceff4>[]</span>jwk <span style=color:#a3be8c>`json:&#34;keys&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// JWKSHandler serve la chiave pubblica in formato JWKS.</span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic>// Montalo su /.well-known/jwks.json.</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>JWKSHandler</span><span style=color:#eceff4>(</span>publicKey <span style=color:#81a1c1>*</span>rsa<span style=color:#eceff4>.</span>PublicKey<span style=color:#eceff4>,</span> keyID <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> http<span style=color:#eceff4>.</span>HandlerFunc <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    key <span style=color:#81a1c1>:=</span> jwk<span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        Kty<span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;RSA&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        Use<span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;sig&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        Kid<span style=color:#eceff4>:</span> keyID<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        Alg<span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;RS256&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        N<span style=color:#eceff4>:</span>   base64<span style=color:#eceff4>.</span>RawURLEncoding<span style=color:#eceff4>.</span><span style=color:#88c0d0>EncodeToString</span><span style=color:#eceff4>(</span>publicKey<span style=color:#eceff4>.</span>N<span style=color:#eceff4>.</span><span style=color:#88c0d0>Bytes</span><span style=color:#eceff4>()),</span>
</span></span><span style=display:flex><span>        E<span style=color:#eceff4>:</span>   base64<span style=color:#eceff4>.</span>RawURLEncoding<span style=color:#eceff4>.</span><span style=color:#88c0d0>EncodeToString</span><span style=color:#eceff4>(</span>big<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewInt</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int64</span><span style=color:#eceff4>(</span>publicKey<span style=color:#eceff4>.</span>E<span style=color:#eceff4>)).</span><span style=color:#88c0d0>Bytes</span><span style=color:#eceff4>()),</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    body<span style=color:#eceff4>,</span> _ <span style=color:#81a1c1>:=</span> json<span style=color:#eceff4>.</span><span style=color:#88c0d0>Marshal</span><span style=color:#eceff4>(</span>jwks<span style=color:#eceff4>{</span>Keys<span style=color:#eceff4>:</span> <span style=color:#eceff4>[]</span>jwk<span style=color:#eceff4>{</span>key<span style=color:#eceff4>}})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>func</span><span style=color:#eceff4>(</span>w http<span style=color:#eceff4>.</span>ResponseWriter<span style=color:#eceff4>,</span> r <span style=color:#81a1c1>*</span>http<span style=color:#eceff4>.</span>Request<span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        w<span style=color:#eceff4>.</span><span style=color:#88c0d0>Header</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>Set</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;Content-Type&#34;</span><span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;application/json&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        w<span style=color:#eceff4>.</span><span style=color:#88c0d0>Header</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>Set</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;Cache-Control&#34;</span><span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;public, max-age=3600&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        w<span style=color:#eceff4>.</span><span style=color:#88c0d0>Write</span><span style=color:#eceff4>(</span>body<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>Gli altri servizi possono usare <a href=https://github.com/lestrrat-go/jwx target=_blank rel=noreferrer>jwx</a> o recuperare il JWKS e verificare i token senza conoscere la chiave privata:</p><div class=highlight-wrapper><div class=codeblock-title>internal/auth/remote_verifier.go</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>package</span> auth
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/lestrrat-go/jwx/v2/jwk&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;github.com/lestrrat-go/jwx/v2/jwt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>type</span> RemoteVerifier <span style=color:#81a1c1;font-weight:700>struct</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    cache   <span style=color:#81a1c1>*</span>jwk<span style=color:#eceff4>.</span>Cache
</span></span><span style=display:flex><span>    jwksURL <span style=color:#81a1c1>string</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#88c0d0>NewRemoteVerifier</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> jwksURL <span style=color:#81a1c1>string</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span>RemoteVerifier<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    cache <span style=color:#81a1c1>:=</span> jwk<span style=color:#eceff4>.</span><span style=color:#88c0d0>NewCache</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>:=</span> cache<span style=color:#eceff4>.</span><span style=color:#88c0d0>Register</span><span style=color:#eceff4>(</span>jwksURL<span style=color:#eceff4>);</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;register jwks: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1>&amp;</span>RemoteVerifier<span style=color:#eceff4>{</span>cache<span style=color:#eceff4>:</span> cache<span style=color:#eceff4>,</span> jwksURL<span style=color:#eceff4>:</span> jwksURL<span style=color:#eceff4>},</span> <span style=color:#81a1c1;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>func</span> <span style=color:#eceff4>(</span>v <span style=color:#81a1c1>*</span>RemoteVerifier<span style=color:#eceff4>)</span> <span style=color:#88c0d0>Verify</span><span style=color:#eceff4>(</span>ctx context<span style=color:#eceff4>.</span>Context<span style=color:#eceff4>,</span> tokenBytes <span style=color:#eceff4>[]</span><span style=color:#81a1c1>byte</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>(</span>jwt<span style=color:#eceff4>.</span>Token<span style=color:#eceff4>,</span> <span style=color:#81a1c1>error</span><span style=color:#eceff4>)</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    keySet<span style=color:#eceff4>,</span> err <span style=color:#81a1c1>:=</span> v<span style=color:#eceff4>.</span>cache<span style=color:#eceff4>.</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>(</span>ctx<span style=color:#eceff4>,</span> v<span style=color:#eceff4>.</span>jwksURL<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>if</span> err <span style=color:#81a1c1>!=</span> <span style=color:#81a1c1;font-weight:700>nil</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>nil</span><span style=color:#eceff4>,</span> fmt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;fetch jwks: %w&#34;</span><span style=color:#eceff4>,</span> err<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>Parse</span><span style=color:#eceff4>(</span>tokenBytes<span style=color:#eceff4>,</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithKeySet</span><span style=color:#eceff4>(</span>keySet<span style=color:#eceff4>),</span> jwt<span style=color:#eceff4>.</span><span style=color:#88c0d0>WithValidate</span><span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>true</span><span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span></span></span></code></pre></div></div><h2 class="relative group">Errori Comuni<div id=errori-comuni class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#errori-comuni aria-label=Ancora>#</a></span></h2><div id=accordion-d46694bd3e92171559186bbd741315c6 class="border border-neutral-200 dark:border-neutral-700 rounded-lg overflow-hidden" data-accordion=collapse data-accordion-separated=false><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>HS256 con segreti condivisi nei microservizi</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Se usi HS256 e tre servizi devono verificare i token, tutti e tre devono avere il segreto. La compromissione di uno qualsiasi di quei servizi permette a un attaccante di falsificare token per tutti i servizi. Usa RS256 con un endpoint JWKS quando piu&rsquo; di un servizio verifica i token.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Accettare token senza validazione exp</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Un token senza un claim di scadenza e&rsquo; valido per sempre. La libreria <code>golang-jwt/jwt</code> non impone la scadenza per default in tutte le versioni. Passa sempre <code>jwt.WithExpirationRequired()</code> al tuo parser. Controlla ogni percorso di validazione dei token nel tuo codebase.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Usare JWT per lo stato di sessione delle web application</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">I JWT memorizzati in <code>localStorage</code> sono accessibili a JavaScript e vulnerabili agli XSS. Le sessioni cookie con <code>HttpOnly</code>, <code>Secure</code> e <code>SameSite=Strict</code> sono piu&rsquo; sicure per le web app. I JWT hanno senso per i client API (app mobile, CLI, service-to-service) dove i cookie non sono applicabili.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Hardcoding dei segreti o caricamento da file env in chiaro</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">La chiave segreta per HS256 o il percorso della chiave privata per RS256 devono provenire da un secrets manager (AWS Secrets Manager, HashiCorp Vault, GCP Secret Manager) o da una variabile d&rsquo;ambiente iniettata dalla piattaforma di deployment. Non committare mai materiale di chiave nel source control o includerlo nelle immagini Docker.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Non validare il claim aud</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Se il tuo auth server emette token per piu&rsquo; servizi e non validi <code>aud</code>, un token emesso per il servizio A e&rsquo; valido anche per il servizio B. Questo viola il principio del minimo privilegio e puo&rsquo; essere sfruttato se il servizio B ha privilegi piu&rsquo; elevati del servizio A.</div></details></div><style>#accordion-d46694bd3e92171559186bbd741315c6>details+details{border-top:1px solid rgb(var(--color-neutral-200))}.dark #accordion-d46694bd3e92171559186bbd741315c6>details+details{border-top-color:rgb(var(--color-neutral-700))}</style><script>(()=>{const e=document.getElementById("accordion-d46694bd3e92171559186bbd741315c6");if(!e)return;const t=e.querySelectorAll("details[data-accordion-item]");t.forEach(e=>{e.addEventListener("toggle",()=>{if(!e.open)return;t.forEach(t=>{t!==e&&t.removeAttribute("open")})})})})()</script><hr><p>Se vuoi approfondire uno di questi argomenti, offro sessioni di coaching 1:1 per ingegneri che lavorano su integrazione AI, architettura cloud e platform engineering. <a href=https://calendly.com/manuelfedele/60min target=_blank rel=noreferrer>Prenota una sessione</a> (50 EUR / 60 min) o scrivimi a <a href=mailto:manuel.fedele+website@gmail.com>manuel.fedele+website@gmail.com</a>.</p></div><h2 class="mt-8 text-2xl font-extrabold mb-10">Articoli correlati</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1511512578047-dfb367046420?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/clipboard-watch-remove-accidentally-typed-passwords/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Monitoraggio della clipboard in Go: rilevamento e redazione di segreti</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-11-26T11:29:46+01:00>26 novembre 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">8 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/security/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Security
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/tooling/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Tooling</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/implementing-djikstra-algorithm-in-go/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>L'Algoritmo di Dijkstra in Go: Implementazione, Ottimizzazione e Uso Reale</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-11-27T17:01:00+00:00>27 novembre 2024</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">9 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/algorithms/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Algorithms</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1617791160505-6f00504e3519?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/the-single-responsibility-principle/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Design di package pulito in Go: Singola responsabilità e coesione</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-03-21T15:10:03+01:00>21 marzo 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">8 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/design-patterns/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Design Patterns
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/architecture/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Architecture</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1518770660439-4636190af475?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/it/posts/implement-desing-patterns-with-golang/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Design Pattern in Go: Implementazioni Idiomatiche</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-02-21T13:16:06+01:00>21 febbraio 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Tempo di lettura">8 minuti</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/it/tags/design-patterns/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Design Patterns
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/it/tags/golang/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Golang</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/it/posts/implementing-djikstra-algorithm-in-go/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;L'Algoritmo di Dijkstra in Go: Implementazione, Ottimizzazione e Uso Reale
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-11-27T17:01:00+00:00>27 novembre 2024</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/it/posts/evaluate-chess-position/><span class=leading-6>Costruire un motore scacchistico - dalla valutazione della posizione alle tecniche di ricerca&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-11-27T17:33:00+00:00>27 novembre 2024</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Torna in cima" title="Torna in cima">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Manuel Fedele</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://manuelfedele.github.io/it/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Cerca tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Chiudi (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>