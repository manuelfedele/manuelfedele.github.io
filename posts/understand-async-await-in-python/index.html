<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls &#183; Git Push and Run</title><meta name=title content="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls &#183; Git Push and Run"><meta name=description content="Software Engineer and Cloud Architect writing about Go, Python, AWS, and AI automation."><meta name=keywords content="asyncio,python,fastapi,concurrency,"><link rel=canonical href=https://manuelfedele.github.io/posts/understand-async-await-in-python/><meta name=author content="Manuel Fedele"><link href=https://github.com/manuelfedele rel=me><link href=https://linkedin.com/in/manuel-fedele rel=me><meta property="og:url" content="https://manuelfedele.github.io/posts/understand-async-await-in-python/"><meta property="og:site_name" content="Git Push and Run"><meta property="og:title" content="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls"><meta property="og:description" content="Async/await is not magic. It is cooperative multitasking for I/O-bound work, built on a single-threaded event loop. Getting it wrong does not crash your program; it silently makes it slower and harder to debug. This post covers what the event loop actually does, how to use asyncio correctly, the FastAPI async model, and the mistakes that cost teams weeks. Python’s async/await syntax landed in Python 3.5 and became genuinely production-ready in Python 3.7 with asyncio.run. Today it powers FastAPI, aiohttp, and most of the modern Python async ecosystem. But a large fraction of the async code I see in the wild has subtle bugs: missing await, calls to blocking libraries inside async functions, or CPU-heavy work that brings the event loop to a halt."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-01T14:50:35+01:00"><meta property="article:modified_time" content="2023-01-01T14:50:35+01:00"><meta property="article:tag" content="Asyncio"><meta property="article:tag" content="Python"><meta property="article:tag" content="Fastapi"><meta property="article:tag" content="Concurrency"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls"><meta name=twitter:description content="Async/await is not magic. It is cooperative multitasking for I/O-bound work, built on a single-threaded event loop. Getting it wrong does not crash your program; it silently makes it slower and harder to debug. This post covers what the event loop actually does, how to use asyncio correctly, the FastAPI async model, and the mistakes that cost teams weeks. Python’s async/await syntax landed in Python 3.5 and became genuinely production-ready in Python 3.7 with asyncio.run. Today it powers FastAPI, aiohttp, and most of the modern Python async ecosystem. But a large fraction of the async code I see in the wild has subtle bugs: missing await, calls to blocking libraries inside async functions, or CPU-heavy work that brings the event loop to a halt."><link type=text/css rel=stylesheet href=/css/main.bundle.min.726dfbf42bcd66e35e2d7258d72fe8fe77509ff76d153e2b46cdbae9c3af9620653459f0119a72d2af4a9b4bc446652d244ad58743d0290e5d8e09e3983b98e5.css integrity="sha512-cm379CvNZuNeLXJY1y/o/ndQn/dtFT4rRs266cOvliBlNFnwEZpy0q9Km0vERmUtJErVh0PQKQ5djgnjmDuY5Q=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.88278edec77139635e1ad294df5b32b7be9338191c5252d3f6f451ace5852d5f82390cccacedab9c64739d8e068b7e8502895cf8f951060c0368f9a73709fcb7.js integrity="sha512-iCeO3sdxOWNeGtKU31syt76TOBkcUlLT9vRRrOWFLV+COQzMrO2rnGRznY4Gi36FAolc+PlRBgwDaPmnNwn8tw==" data-copy=Copy data-copied=Copied></script><script defer type=text/javascript src=/js/mermaid.bundle.c63c50c6884d5e5a17085b7ea24a2ef1f2c96af692b3e243dfab2ab9ef6e6c045a111b16d5cd3ce4d3f1a4919e6a86c4d49c16f5cf9b44db6dd7f6ffbc8d4b49.js integrity="sha512-xjxQxohNXloXCFt+okou8fLJavaSs+JD36sque9ubARaERsW1c085NPxpJGeaobE1JwW9c+bRNtt1/b/vI1LSQ=="></script><script src=/js/shortcodes/tabs.min.b9b8a6b2cf6c81163025e44a18c0ccce600efe2dfc29d2d11515fe41b8e1e8e00896759b9e55eab7032ab15d1bec124c32e8996685e563de84ad243eb61ec236.js integrity="sha512-ubimss9sgRYwJeRKGMDMzmAO/i38KdLRFRX+Qbjh6OAIlnWbnlXqtwMqsV0b7BJMMuiZZoXlY96ErSQ+th7CNg==" crossorigin=anonymous></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Python Async\/Await in Practice: asyncio, FastAPI, and Common Pitfalls","headline":"Python Async\/Await in Practice: asyncio, FastAPI, and Common Pitfalls","inLanguage":"en","url":"https://manuelfedele.github.io/posts/understand-async-await-in-python/","author":{"@type":"Person","name":"Manuel Fedele"},"copyrightYear":"2023","dateCreated":"2023-01-01T14:50:35\u002b01:00","datePublished":"2023-01-01T14:50:35\u002b01:00","dateModified":"2023-01-01T14:50:35\u002b01:00","keywords":["asyncio","python","fastapi","concurrency"],"mainEntityOfPage":"true","wordCount":"1856"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">Git Push and Run</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title=Posts><span class="text-base font-medium break-normal">Blog
</span></a><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=About title=About><span class="text-base font-medium break-normal">About
</span></a><a href=/coaching/ class="flex items-center bf-icon-color-hover" aria-label=Coaching title=Coaching><span class="text-base font-medium break-normal">Coaching
</span></a><a href=https://github.com/manuelfedele target=_blank class="flex items-center bf-icon-color-hover" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls">EN</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/understand-async-await-in-python/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls">EN
</span></a><a href=/it/posts/understand-async-await-in-python/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Python Async/Await in Pratica: asyncio, FastAPI e Insidie Comuni">IT</span></a></li></ul></div><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Blog</span></a></div><div class=px-2><a href=/about/ aria-label=About class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=About class="text-2xl font-bold tracking-tight">About</span></a></div><div class=px-2><a href=/coaching/ aria-label=Coaching class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Coaching class="text-2xl font-bold tracking-tight">Coaching</span></a></div><div class=px-2><a href=https://github.com/manuelfedele aria-label=github target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span><span title class="text-2xl font-bold tracking-tight"></span></a></div><div class="flex flex-wrap items-center [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl! [&_.translation_button_span]:text-base! [&_.translation_.menuhide_span]:text-sm! gap-x-6 ps-2 mt-8 pt-8 border-t bf-border-color"><div class="translation nested-menu"><button class="cursor-pointer flex items-center">
<span class=me-1><span class="relative block icon"><svg viewBox="0 0 640 512"><path fill="currentColor" d="M0 128C0 92.7 28.7 64 64 64H256h48 16H576c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H320 304 256 64c-35.3.0-64-28.7-64-64V128zm320 0V384H576V128H320zM178.3 175.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4l-64-144zM160 233.2 179 276H141l19-42.8zM448 164c11 0 20 9 20 20v4h44 16c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5.0-28.3s20.5-7.8 28.3.0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45H448 376c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20z"/></svg></span>
</span><span class="text-sm font-medium bf-icon-color-hover" title="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls">EN</span></button><ul class=menuhide><li class="rounded-xl backdrop-blur shadow-2xl p-2 flex flex-col gap-1"><a href=/posts/understand-async-await-in-python/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls">EN
</span></a><a href=/it/posts/understand-async-await-in-python/ class="flex items-center bf-icon-color-hover px-3 py-1"><span class="text-sm font-sm" title="Python Async/Await in Pratica: asyncio, FastAPI e Insidie Comuni">IT</span></a></li></ul></div></div></nav></div></div></div></div></div><script>(function(){var t,n,e=document.querySelector(".main-menu");if(!e)return;t=window.location.pathname,n=e.querySelectorAll('a[href="'+t+'"]'),n.forEach(function(e){var t=e.querySelectorAll("span");t.forEach(function(e){e.classList.add("active")})})})()</script></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src="https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?w=1200&amp;q=85" role=presentation loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-xl bg-neutral-100/75 dark:bg-neutral-800/60"></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=background-blur data-image-id=background-image data-image-url="https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?w=1200&amp;q=85"></script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Python Async/Await in Practice: asyncio, FastAPI, and Common Pitfalls</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-01-01T14:50:35+01:00>1 January 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/asyncio/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Asyncio
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/fastapi/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Fastapi
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/concurrency/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Concurrency</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-event-loop-what-it-actually-does>The Event Loop: What It Actually Does</a></li><li><a href=#basic-coroutines>Basic Coroutines</a></li><li><a href=#asynciogather-running-coroutines-concurrently>asyncio.gather: Running Coroutines Concurrently</a></li><li><a href=#asynciocreate_task-vs-gather>asyncio.create_task vs gather</a></li><li><a href=#blocking-the-event-loop-the-most-common-mistake>Blocking the Event Loop: The Most Common Mistake</a></li><li><a href=#async-context-managers-and-async-generators>Async Context Managers and Async Generators</a></li><li><a href=#fastapi-a-real-async-endpoint>FastAPI: A Real Async Endpoint</a></li><li><a href=#when-async-is-not-faster>When Async is NOT Faster</a></li><li><a href=#common-mistakes>Common Mistakes</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-event-loop-what-it-actually-does>The Event Loop: What It Actually Does</a></li><li><a href=#basic-coroutines>Basic Coroutines</a></li><li><a href=#asynciogather-running-coroutines-concurrently>asyncio.gather: Running Coroutines Concurrently</a></li><li><a href=#asynciocreate_task-vs-gather>asyncio.create_task vs gather</a></li><li><a href=#blocking-the-event-loop-the-most-common-mistake>Blocking the Event Loop: The Most Common Mistake</a></li><li><a href=#async-context-managers-and-async-generators>Async Context Managers and Async Generators</a></li><li><a href=#fastapi-a-real-async-endpoint>FastAPI: A Real Async Endpoint</a></li><li><a href=#when-async-is-not-faster>When Async is NOT Faster</a></li><li><a href=#common-mistakes>Common Mistakes</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><div class="lead text-neutral-500 dark:text-neutral-400 !mb-9 text-xl">Async/await is not magic. It is cooperative multitasking for I/O-bound work, built on a single-threaded event loop. Getting it wrong does not crash your program; it silently makes it slower and harder to debug. This post covers what the event loop actually does, how to use asyncio correctly, the FastAPI async model, and the mistakes that cost teams weeks.</div><p>Python&rsquo;s <code>async</code>/<code>await</code> syntax landed in Python 3.5 and became genuinely production-ready in Python 3.7 with <code>asyncio.run</code>. Today it powers FastAPI, aiohttp, and most of the modern Python async ecosystem. But a large fraction of the async code I see in the wild has subtle bugs: missing <code>await</code>, calls to blocking libraries inside async functions, or CPU-heavy work that brings the event loop to a halt.</p><p>This post is a systematic walkthrough of how async Python actually works, when it helps, when it does not, and the patterns that make async code correct and maintainable.</p><h2 class="relative group">The Event Loop: What It Actually Does<div id=the-event-loop-what-it-actually-does class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-event-loop-what-it-actually-does aria-label=Anchor>#</a></span></h2><p>The event loop is a single OS thread that runs an infinite loop. On each iteration it checks: are any I/O operations complete? If yes, resume the coroutine that was waiting for them.</p><pre class="not-prose mermaid">
sequenceDiagram
    participant EL as Event Loop
    participant C1 as Coroutine 1
    participant C2 as Coroutine 2
    participant IO as OS / Network

    EL->>C1: resume
    C1->>IO: await socket.read()
    C1-->>EL: suspend (waiting for IO)
    EL->>C2: resume
    C2->>IO: await asyncio.sleep(1)
    C2-->>EL: suspend
    IO-->>EL: socket data ready
    EL->>C1: resume with data
    C1-->>EL: done
</pre><p>The critical insight: there is no parallelism here. Only one coroutine runs at any given instant. The speedup comes from the fact that while coroutine 1 is waiting for a network response, the event loop runs coroutine 2 instead of blocking the thread. If coroutine 2 does CPU work for 500ms instead of awaiting something, coroutine 1&rsquo;s latency grows by 500ms regardless of how fast the network is.</p><h2 class="relative group">Basic Coroutines<div id=basic-coroutines class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#basic-coroutines aria-label=Anchor>#</a></span></h2><p>An <code>async def</code> function is a coroutine function. Calling it returns a coroutine object; it does not execute anything until you <code>await</code> it or schedule it.</p><div class=highlight-wrapper><div class=codeblock-title>basics.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>fetch_user</span><span style=color:#eceff4>(</span>user_id<span style=color:#eceff4>:</span> <span style=color:#81a1c1>int</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>dict</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Simulate a database query.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>0.05</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;id&#34;</span><span style=color:#eceff4>:</span> user_id<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;name&#34;</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;Alice&#34;</span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>main</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    user <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>await</span> fetch_user<span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span>user<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#81a1c1>.</span>run<span style=color:#eceff4>(</span>main<span style=color:#eceff4>())</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=warning><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></div><div class=grow>Warning</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Calling <code>fetch_user(1)</code> without <code>await</code> does nothing and returns a coroutine object. Python will emit a <code>RuntimeWarning: coroutine 'fetch_user' was never awaited</code> in newer versions, but older code often silently discards the coroutine. This is one of the hardest bugs to spot in async code: a function appears to run but its result is never used and its I/O never happens.</p></div></div><h2 class="relative group">asyncio.gather: Running Coroutines Concurrently<div id=asynciogather-running-coroutines-concurrently class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#asynciogather-running-coroutines-concurrently aria-label=Anchor>#</a></span></h2><p>The most common real-world async pattern is fetching from multiple sources concurrently and waiting for all of them to finish. <code>asyncio.gather</code> is the primary tool for this.</p><div class=highlight-wrapper><div class=codeblock-title>gather_example.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>fetch_from_service</span><span style=color:#eceff4>(</span>name<span style=color:#eceff4>:</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>,</span> delay<span style=color:#eceff4>:</span> <span style=color:#81a1c1>float</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span>delay<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;</span><span style=color:#a3be8c>{</span>name<span style=color:#a3be8c>}</span><span style=color:#a3be8c> responded after </span><span style=color:#a3be8c>{</span>delay<span style=color:#a3be8c>}</span><span style=color:#a3be8c>s&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>main</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    start <span style=color:#81a1c1>=</span> time<span style=color:#81a1c1>.</span>monotonic<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Sequential: total time = 0.3 + 0.2 + 0.4 = 0.9s</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># r1 = await fetch_from_service(&#34;users&#34;, 0.3)</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># r2 = await fetch_from_service(&#34;orders&#34;, 0.2)</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># r3 = await fetch_from_service(&#34;inventory&#34;, 0.4)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Concurrent with gather: total time = max(0.3, 0.2, 0.4) = ~0.4s</span>
</span></span><span style=display:flex><span>    r1<span style=color:#eceff4>,</span> r2<span style=color:#eceff4>,</span> r3 <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>gather<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>        fetch_from_service<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;users&#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>0.3</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>        fetch_from_service<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;orders&#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>0.2</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>        fetch_from_service<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;inventory&#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>0.4</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    elapsed <span style=color:#81a1c1>=</span> time<span style=color:#81a1c1>.</span>monotonic<span style=color:#eceff4>()</span> <span style=color:#81a1c1>-</span> start
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;All done in </span><span style=color:#a3be8c>{</span>elapsed<span style=color:#a3be8c>:</span><span style=color:#a3be8c>.2f</span><span style=color:#a3be8c>}</span><span style=color:#a3be8c>s&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span>r1<span style=color:#eceff4>,</span> r2<span style=color:#eceff4>,</span> r3<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#81a1c1>.</span>run<span style=color:#eceff4>(</span>main<span style=color:#eceff4>())</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Note</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p><code>asyncio.gather</code> returns results in the same order as the input coroutines, regardless of which finished first. If any coroutine raises an exception, <code>gather</code> cancels the rest and re-raises it by default. Pass <code>return_exceptions=True</code> to collect exceptions as values instead of propagating them.</p></div></div><h2 class="relative group">asyncio.create_task vs gather<div id=asynciocreate_task-vs-gather class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#asynciocreate_task-vs-gather aria-label=Anchor>#</a></span></h2><p><code>asyncio.gather</code> runs coroutines concurrently and waits for all of them. <code>asyncio.create_task</code> schedules a coroutine to run in the background and returns a <code>Task</code> handle immediately.</p><div class=highlight-wrapper><div class=codeblock-title>tasks_vs_gather.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>background_job</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;background job done&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>main</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Fire-and-forget: start the job but don&#39;t wait for it.</span>
</span></span><span style=display:flex><span>    task <span style=color:#81a1c1>=</span> asyncio<span style=color:#81a1c1>.</span>create_task<span style=color:#eceff4>(</span>background_job<span style=color:#eceff4>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Do other work while background_job runs.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>0.1</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;main work done&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Optionally wait for it before shutdown.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#81a1c1>.</span>run<span style=color:#eceff4>(</span>main<span style=color:#eceff4>())</span></span></span></code></pre></div></div><p>Use <code>create_task</code> when you want to fire-and-forget or manage task lifecycles explicitly. Use <code>gather</code> when you need all results before continuing.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=important><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></div><div class=grow>Important</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>Always keep a reference to tasks created with <code>create_task</code>. If the task object is garbage-collected before it completes, Python cancels it. The common pattern is to keep tasks in a <code>set</code> and use <code>task.add_done_callback(tasks.discard)</code> to clean them up.</p></div></div><h2 class="relative group">Blocking the Event Loop: The Most Common Mistake<div id=blocking-the-event-loop-the-most-common-mistake class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#blocking-the-event-loop-the-most-common-mistake aria-label=Anchor>#</a></span></h2><p>The entire async model collapses if you call a blocking function inside a coroutine. <code>time.sleep</code>, <code>requests.get</code>, any CPU-heavy computation, or a synchronous database driver will freeze the event loop for every other coroutine for the duration of that call.</p><div class=highlight-wrapper><div class=codeblock-title>blocking_mistake.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>time</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>requests</span>  <span style=color:#616e87;font-style:italic># synchronous HTTP library</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>bad_handler</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># This blocks the ENTIRE event loop for 2 seconds.</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># No other coroutine can run while this sleeps.</span>
</span></span><span style=display:flex><span>    time<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    response <span style=color:#81a1c1>=</span> requests<span style=color:#81a1c1>.</span>get<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;https://api.example.com/data&#34;</span><span style=color:#eceff4>)</span>  <span style=color:#616e87;font-style:italic># also blocking</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> response<span style=color:#81a1c1>.</span>text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>good_handler</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Non-blocking sleep: yields control to the event loop.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Non-blocking HTTP: use an async library.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>aiohttp</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>with</span> aiohttp<span style=color:#81a1c1>.</span>ClientSession<span style=color:#eceff4>()</span> <span style=color:#81a1c1;font-weight:700>as</span> session<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>with</span> session<span style=color:#81a1c1>.</span>get<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;https://api.example.com/data&#34;</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1;font-weight:700>as</span> response<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>await</span> response<span style=color:#81a1c1>.</span>text<span style=color:#eceff4>()</span></span></span></code></pre></div></div><p>When you must call a blocking function (legacy library, CPU work, no async alternative), use <code>run_in_executor</code> to offload it to a thread pool:</p><div class=highlight-wrapper><div class=codeblock-title>run_in_executor.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>time</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>from</span> <span style=color:#8fbcbb>concurrent.futures</span> <span style=color:#81a1c1;font-weight:700>import</span> ThreadPoolExecutor
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>executor <span style=color:#81a1c1>=</span> ThreadPoolExecutor<span style=color:#eceff4>(</span>max_workers<span style=color:#81a1c1>=</span><span style=color:#b48ead>4</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>blocking_cpu_work</span><span style=color:#eceff4>(</span>n<span style=color:#eceff4>:</span> <span style=color:#81a1c1>int</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>int</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Simulate CPU-bound work.</span>
</span></span><span style=display:flex><span>    time<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>0.5</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> n <span style=color:#81a1c1>*</span> n
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>main</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    loop <span style=color:#81a1c1>=</span> asyncio<span style=color:#81a1c1>.</span>get_running_loop<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Run blocking_cpu_work in a thread without freezing the event loop.</span>
</span></span><span style=display:flex><span>    result <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>await</span> loop<span style=color:#81a1c1>.</span>run_in_executor<span style=color:#eceff4>(</span>executor<span style=color:#eceff4>,</span> blocking_cpu_work<span style=color:#eceff4>,</span> <span style=color:#b48ead>42</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span>result<span style=color:#eceff4>)</span></span></span></code></pre></div></div><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=tip><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 384 512"><path fill="currentColor" d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438.0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1H112L112.1 454.3zM191.4.0132C89.44.3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8 16.53 18.84 42.34 58.23 52.22 91.45.0313.25.0938.5166.125.7823h160.2c.0313-.2656.0938-.5166.125-.7823 9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1 368 78.61 288.9-.2837 191.4.0132zM192 96.01c-44.13.0-80 35.89-80 79.1.0 9.69-7.2 16.89-16 16.89S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1 8.844.0 16 7.159 16 16S200.8 96.01 192 96.01z"/></svg></span></div><div class=grow>Tip</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>For true CPU-bound parallelism (image processing, ML inference, cryptography), use <code>ProcessPoolExecutor</code> instead of <code>ThreadPoolExecutor</code>. Threads share the GIL; processes do not.</p></div></div><h2 class="relative group">Async Context Managers and Async Generators<div id=async-context-managers-and-async-generators class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#async-context-managers-and-async-generators aria-label=Anchor>#</a></span></h2><p>Any resource that needs setup and teardown around I/O can implement <code>__aenter__</code> and <code>__aexit__</code>.</p><div class=highlight-wrapper><div class=codeblock-title>async_context.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>from</span> <span style=color:#8fbcbb>contextlib</span> <span style=color:#81a1c1;font-weight:700>import</span> asynccontextmanager
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>from</span> <span style=color:#8fbcbb>typing</span> <span style=color:#81a1c1;font-weight:700>import</span> AsyncGenerator
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d08770>@asynccontextmanager</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>managed_connection</span><span style=color:#eceff4>(</span>host<span style=color:#eceff4>:</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> AsyncGenerator<span style=color:#eceff4>[</span><span style=color:#81a1c1>dict</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>]:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;connecting to </span><span style=color:#a3be8c>{</span>host<span style=color:#a3be8c>}</span><span style=color:#a3be8c>&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>0.01</span><span style=color:#eceff4>)</span>  <span style=color:#616e87;font-style:italic># simulate async connect</span>
</span></span><span style=display:flex><span>    conn <span style=color:#81a1c1>=</span> <span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;host&#34;</span><span style=color:#eceff4>:</span> host<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;open&#34;</span><span style=color:#eceff4>:</span> <span style=color:#81a1c1;font-weight:700>True</span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>try</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>yield</span> conn
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>finally</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        conn<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#34;open&#34;</span><span style=color:#eceff4>]</span> <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>False</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;closed connection to </span><span style=color:#a3be8c>{</span>host<span style=color:#a3be8c>}</span><span style=color:#a3be8c>&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>streamed_results</span><span style=color:#eceff4>(</span>query<span style=color:#eceff4>:</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> AsyncGenerator<span style=color:#eceff4>[</span><span style=color:#81a1c1>dict</span><span style=color:#eceff4>,</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>]:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># Async generator: yields rows as they arrive from the database.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>for</span> i <span style=color:#81a1c1;font-weight:700>in</span> <span style=color:#81a1c1>range</span><span style=color:#eceff4>(</span><span style=color:#b48ead>5</span><span style=color:#eceff4>):</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>sleep<span style=color:#eceff4>(</span><span style=color:#b48ead>0.01</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>yield</span> <span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;row&#34;</span><span style=color:#eceff4>:</span> i<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;query&#34;</span><span style=color:#eceff4>:</span> query<span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>main</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>with</span> managed_connection<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;db.internal&#34;</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1;font-weight:700>as</span> conn<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>for</span> row <span style=color:#81a1c1;font-weight:700>in</span> streamed_results<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;SELECT * FROM users&#34;</span><span style=color:#eceff4>):</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span>row<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>asyncio<span style=color:#81a1c1>.</span>run<span style=color:#eceff4>(</span>main<span style=color:#eceff4>())</span></span></span></code></pre></div></div><h2 class="relative group">FastAPI: A Real Async Endpoint<div id=fastapi-a-real-async-endpoint class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#fastapi-a-real-async-endpoint aria-label=Anchor>#</a></span></h2><p>FastAPI is built on Starlette, which uses an async event loop (uvicorn/uvloop). Async endpoint handlers let you make multiple I/O calls concurrently within a single request.</p><div class=highlight-wrapper><div class=codeblock-title>app/main.py</div><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>httpx</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>from</span> <span style=color:#8fbcbb>fastapi</span> <span style=color:#81a1c1;font-weight:700>import</span> FastAPI<span style=color:#eceff4>,</span> HTTPException
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#81a1c1>=</span> FastAPI<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SERVICES <span style=color:#81a1c1>=</span> <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;user&#34;</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;https://internal.example.com/users&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;order&#34;</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;https://internal.example.com/orders&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>    <span style=color:#a3be8c>&#34;inventory&#34;</span><span style=color:#eceff4>:</span> <span style=color:#a3be8c>&#34;https://internal.example.com/inventory&#34;</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>fetch_json</span><span style=color:#eceff4>(</span>client<span style=color:#eceff4>:</span> httpx<span style=color:#81a1c1>.</span>AsyncClient<span style=color:#eceff4>,</span> url<span style=color:#eceff4>:</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>dict</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    response <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>await</span> client<span style=color:#81a1c1>.</span>get<span style=color:#eceff4>(</span>url<span style=color:#eceff4>,</span> timeout<span style=color:#81a1c1>=</span><span style=color:#b48ead>2.0</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    response<span style=color:#81a1c1>.</span>raise_for_status<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> response<span style=color:#81a1c1>.</span>json<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d08770>@app.get</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;/dashboard/</span><span style=color:#a3be8c>{user_id}</span><span style=color:#a3be8c>&#34;</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>get_dashboard</span><span style=color:#eceff4>(</span>user_id<span style=color:#eceff4>:</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>dict</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>with</span> httpx<span style=color:#81a1c1>.</span>AsyncClient<span style=color:#eceff4>()</span> <span style=color:#81a1c1;font-weight:700>as</span> client<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>try</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            user<span style=color:#eceff4>,</span> orders<span style=color:#eceff4>,</span> inventory <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>gather<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>                fetch_json<span style=color:#eceff4>(</span>client<span style=color:#eceff4>,</span> <span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;</span><span style=color:#a3be8c>{</span>SERVICES<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#39;user&#39;</span><span style=color:#eceff4>]</span><span style=color:#a3be8c>}</span><span style=color:#a3be8c>/</span><span style=color:#a3be8c>{</span>user_id<span style=color:#a3be8c>}</span><span style=color:#a3be8c>&#34;</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>                fetch_json<span style=color:#eceff4>(</span>client<span style=color:#eceff4>,</span> <span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;</span><span style=color:#a3be8c>{</span>SERVICES<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#39;order&#39;</span><span style=color:#eceff4>]</span><span style=color:#a3be8c>}</span><span style=color:#a3be8c>?user_id=</span><span style=color:#a3be8c>{</span>user_id<span style=color:#a3be8c>}</span><span style=color:#a3be8c>&#34;</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>                fetch_json<span style=color:#eceff4>(</span>client<span style=color:#eceff4>,</span> <span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;</span><span style=color:#a3be8c>{</span>SERVICES<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#39;inventory&#39;</span><span style=color:#eceff4>]</span><span style=color:#a3be8c>}</span><span style=color:#a3be8c>?user_id=</span><span style=color:#a3be8c>{</span>user_id<span style=color:#a3be8c>}</span><span style=color:#a3be8c>&#34;</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>                return_exceptions<span style=color:#81a1c1>=</span><span style=color:#81a1c1;font-weight:700>True</span><span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>except</span> <span style=color:#bf616a>Exception</span> <span style=color:#81a1c1;font-weight:700>as</span> exc<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>raise</span> HTTPException<span style=color:#eceff4>(</span>status_code<span style=color:#81a1c1>=</span><span style=color:#b48ead>502</span><span style=color:#eceff4>,</span> detail<span style=color:#81a1c1>=</span><span style=color:#81a1c1>str</span><span style=color:#eceff4>(</span>exc<span style=color:#eceff4>))</span> <span style=color:#81a1c1;font-weight:700>from</span> <span style=color:#8fbcbb>exc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#eceff4>{</span><span style=color:#a3be8c>&#34;user&#34;</span><span style=color:#eceff4>:</span> user<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;orders&#34;</span><span style=color:#eceff4>:</span> orders<span style=color:#eceff4>,</span> <span style=color:#a3be8c>&#34;inventory&#34;</span><span style=color:#eceff4>:</span> inventory<span style=color:#eceff4>}</span></span></span></code></pre></div></div><p>This endpoint fires three HTTP requests simultaneously. Total response time is bounded by the slowest service, not by the sum of all three latencies.</p><div class="admonition relative overflow-hidden rounded-lg border-l-4 my-3 px-4 py-3 shadow-sm" data-type=note><div class="flex items-center gap-2 font-semibold text-inherit"><div class="flex shrink-0 h-5 w-5 items-center justify-center text-lg"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 0C114.6.0.0 114.6.0 256s114.6 256 256 256 256-114.6 256-256S397.4.0 256 0zm0 128c17.67.0 32 14.33 32 32 0 17.67-14.33 32-32 32s-32-14.3-32-32 14.3-32 32-32zm40 256h-80c-13.2.0-24-10.7-24-24s10.75-24 24-24h16v-64h-8c-13.25.0-24-10.75-24-24s10.8-24 24-24h32c13.25.0 24 10.75 24 24v88h16c13.25.0 24 10.75 24 24s-10.7 24-24 24z"/></svg></span></div><div class=grow>Note</div></div><div class="admonition-content mt-3 text-base leading-relaxed text-inherit"><p>FastAPI allows both sync and async handlers. If you define a handler as <code>def</code> (not <code>async def</code>), FastAPI runs it in a thread pool automatically. This means you can safely use synchronous database drivers in sync handlers. The mistake is defining an <code>async def</code> handler and then calling a blocking library inside it.</p></div></div><h2 class="relative group">When Async is NOT Faster<div id=when-async-is-not-faster class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#when-async-is-not-faster aria-label=Anchor>#</a></span></h2><p>Async gives you concurrency, not speed. It helps when:</p><ul><li>You are waiting for I/O (network, database, filesystem).</li><li>You have many concurrent requests that would otherwise idle threads.</li></ul><p>It does not help when:</p><ul><li>Your work is CPU-bound (hashing, compression, ML inference).</li><li>You have very few concurrent requests (the overhead of the event loop scheduling costs more than it saves).</li><li>All your I/O is already fast (sub-millisecond in-process operations).</li></ul><div class="tab__container w-full"><div class=tab__nav role=tablist><div class="flex flex-wrap gap-1"><button class="tab__button px-3 py-2 text-sm font-semibold border-b-2 border-transparent rounded-t-md hover:bg-neutral-200 dark:hover:bg-neutral-700 tab--active" role=tab aria-selected=true data-tab-index=0 data-tab-label>
<span class="flex items-center gap-1"></span></button><button class="tab__button px-3 py-2 text-sm font-semibold border-b-2 border-transparent rounded-t-md hover:bg-neutral-200 dark:hover:bg-neutral-700" role=tab aria-selected=false data-tab-index=1 data-tab-label>
<span class="flex items-center gap-1"></span></button><button class="tab__button px-3 py-2 text-sm font-semibold border-b-2 border-transparent rounded-t-md hover:bg-neutral-200 dark:hover:bg-neutral-700" role=tab aria-selected=false data-tab-index=2 data-tab-label>
<span class="flex items-center gap-1"></span></button></div></div><div class="tab__content mt-4"><div class="tab__panel tab--active" data-tab-index=0><div class=highlight-wrapper><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>time</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>requests</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>fetch_all_sync</span><span style=color:#eceff4>(</span>urls<span style=color:#eceff4>:</span> <span style=color:#81a1c1>list</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>str</span><span style=color:#eceff4>])</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>list</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>str</span><span style=color:#eceff4>]:</span>
</span></span><span style=display:flex><span>    results <span style=color:#81a1c1>=</span> <span style=color:#eceff4>[]</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>for</span> url <span style=color:#81a1c1;font-weight:700>in</span> urls<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#616e87;font-style:italic># Each call waits for the previous one to complete.</span>
</span></span><span style=display:flex><span>        r <span style=color:#81a1c1>=</span> requests<span style=color:#81a1c1>.</span>get<span style=color:#eceff4>(</span>url<span style=color:#eceff4>,</span> timeout<span style=color:#81a1c1>=</span><span style=color:#b48ead>2</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        results<span style=color:#81a1c1>.</span>append<span style=color:#eceff4>(</span>r<span style=color:#81a1c1>.</span>text<span style=color:#eceff4>[:</span><span style=color:#b48ead>50</span><span style=color:#eceff4>])</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> results
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic># 10 URLs x 200ms each = ~2000ms total</span>
</span></span><span style=display:flex><span>start <span style=color:#81a1c1>=</span> time<span style=color:#81a1c1>.</span>monotonic<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>fetch_all_sync<span style=color:#eceff4>([</span><span style=color:#a3be8c>&#34;https://httpbin.org/delay/0.2&#34;</span><span style=color:#eceff4>]</span> <span style=color:#81a1c1>*</span> <span style=color:#b48ead>10</span><span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;sync: </span><span style=color:#a3be8c>{</span>time<span style=color:#81a1c1>.</span>monotonic<span style=color:#eceff4>()</span> <span style=color:#81a1c1>-</span> start<span style=color:#a3be8c>:</span><span style=color:#a3be8c>.2f</span><span style=color:#a3be8c>}</span><span style=color:#a3be8c>s&#34;</span><span style=color:#eceff4>)</span>  <span style=color:#616e87;font-style:italic># ~2.0s</span></span></span></code></pre></div></div></div><div class=tab__panel data-tab-index=1><div class=highlight-wrapper><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>time</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>aiohttp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>fetch_all_async</span><span style=color:#eceff4>(</span>urls<span style=color:#eceff4>:</span> <span style=color:#81a1c1>list</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>str</span><span style=color:#eceff4>])</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>list</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>str</span><span style=color:#eceff4>]:</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>with</span> aiohttp<span style=color:#81a1c1>.</span>ClientSession<span style=color:#eceff4>()</span> <span style=color:#81a1c1;font-weight:700>as</span> session<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>fetch</span><span style=color:#eceff4>(</span>url<span style=color:#eceff4>:</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>str</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>with</span> session<span style=color:#81a1c1>.</span>get<span style=color:#eceff4>(</span>url<span style=color:#eceff4>,</span> timeout<span style=color:#81a1c1>=</span>aiohttp<span style=color:#81a1c1>.</span>ClientTimeout<span style=color:#eceff4>(</span>total<span style=color:#81a1c1>=</span><span style=color:#b48ead>2</span><span style=color:#eceff4>))</span> <span style=color:#81a1c1;font-weight:700>as</span> r<span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>                text <span style=color:#81a1c1>=</span> <span style=color:#81a1c1;font-weight:700>await</span> r<span style=color:#81a1c1>.</span>text<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>                <span style=color:#81a1c1;font-weight:700>return</span> text<span style=color:#eceff4>[:</span><span style=color:#b48ead>50</span><span style=color:#eceff4>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>gather<span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span style=color:#eceff4>[</span>fetch<span style=color:#eceff4>(</span>url<span style=color:#eceff4>)</span> <span style=color:#81a1c1;font-weight:700>for</span> url <span style=color:#81a1c1;font-weight:700>in</span> urls<span style=color:#eceff4>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#616e87;font-style:italic># 10 URLs x 200ms each, all concurrent = ~200ms total</span>
</span></span><span style=display:flex><span>start <span style=color:#81a1c1>=</span> time<span style=color:#81a1c1>.</span>monotonic<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>asyncio<span style=color:#81a1c1>.</span>run<span style=color:#eceff4>(</span>fetch_all_async<span style=color:#eceff4>([</span><span style=color:#a3be8c>&#34;https://httpbin.org/delay/0.2&#34;</span><span style=color:#eceff4>]</span> <span style=color:#81a1c1>*</span> <span style=color:#b48ead>10</span><span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>print</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>f</span><span style=color:#a3be8c>&#34;async: </span><span style=color:#a3be8c>{</span>time<span style=color:#81a1c1>.</span>monotonic<span style=color:#eceff4>()</span> <span style=color:#81a1c1>-</span> start<span style=color:#a3be8c>:</span><span style=color:#a3be8c>.2f</span><span style=color:#a3be8c>}</span><span style=color:#a3be8c>s&#34;</span><span style=color:#eceff4>)</span>  <span style=color:#616e87;font-style:italic># ~0.2s</span></span></span></code></pre></div></div></div><div class=tab__panel data-tab-index=2><div class=highlight-wrapper><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>hashlib</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>import</span> <span style=color:#8fbcbb>time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>hash_work</span><span style=color:#eceff4>(</span>data<span style=color:#eceff4>:</span> <span style=color:#81a1c1>bytes</span><span style=color:#eceff4>,</span> iterations<span style=color:#eceff4>:</span> <span style=color:#81a1c1>int</span><span style=color:#eceff4>)</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1>bytes</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># CPU-bound: no I/O to yield on.</span>
</span></span><span style=display:flex><span>    h <span style=color:#81a1c1>=</span> data
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>for</span> _ <span style=color:#81a1c1;font-weight:700>in</span> <span style=color:#81a1c1>range</span><span style=color:#eceff4>(</span>iterations<span style=color:#eceff4>):</span>
</span></span><span style=display:flex><span>        h <span style=color:#81a1c1>=</span> hashlib<span style=color:#81a1c1>.</span>sha256<span style=color:#eceff4>(</span>h<span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span>digest<span style=color:#eceff4>()</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>async</span> <span style=color:#81a1c1;font-weight:700>def</span> <span style=color:#88c0d0>wrong_approach</span><span style=color:#eceff4>()</span> <span style=color:#81a1c1>-&gt;</span> <span style=color:#81a1c1;font-weight:700>None</span><span style=color:#eceff4>:</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># This blocks the event loop for the entire duration.</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># asyncio.gather over CPU work gives zero benefit.</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>await</span> asyncio<span style=color:#81a1c1>.</span>gather<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>        asyncio<span style=color:#81a1c1>.</span>to_thread<span style=color:#eceff4>(</span>hash_work<span style=color:#eceff4>,</span> <span style=color:#a3be8c>b</span><span style=color:#a3be8c>&#34;data1&#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>100_000</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>        asyncio<span style=color:#81a1c1>.</span>to_thread<span style=color:#eceff4>(</span>hash_work<span style=color:#eceff4>,</span> <span style=color:#a3be8c>b</span><span style=color:#a3be8c>&#34;data2&#34;</span><span style=color:#eceff4>,</span> <span style=color:#b48ead>100_000</span><span style=color:#eceff4>),</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># asyncio.to_thread is correct (uses thread pool),</span>
</span></span><span style=display:flex><span>    <span style=color:#616e87;font-style:italic># but for true CPU parallelism use ProcessPoolExecutor.</span></span></span></code></pre></div></div></div></div></div><h2 class="relative group">Common Mistakes<div id=common-mistakes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#common-mistakes aria-label=Anchor>#</a></span></h2><div id=accordion-29a859743cbd465fc6093f5dd45f048b class="border border-neutral-200 dark:border-neutral-700 rounded-lg overflow-hidden" data-accordion=collapse data-accordion-separated=false><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Missing await on a coroutine call</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300"><code>result = some_async_function()</code> without <code>await</code> gives you a coroutine object, not the result. The function body never executes. Python 3.10+ emits a warning, but in production logs these are often swallowed. Always <code>await</code> coroutine calls, or explicitly schedule them with <code>create_task</code>.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Calling time.sleep or requests.get inside async functions</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Any blocking call inside an async function freezes the entire event loop. Under a FastAPI server, this means all concurrent requests freeze until your one blocking call returns. Replace <code>time.sleep</code> with <code>await asyncio.sleep</code>, and replace <code>requests</code> with <code>httpx</code> (async mode) or <code>aiohttp</code>.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Calling asyncio.run inside a running loop</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300"><code>asyncio.run</code> creates and runs a new event loop. Calling it from within an already-running loop (e.g., from a Jupyter notebook or from inside a FastAPI handler) raises <code>RuntimeError: This event loop is already running</code>. Use <code>await</code> directly, or in Jupyter use the <code>nest_asyncio</code> library as a workaround.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Using async without an async-compatible library</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">Making your handler <code>async def</code> while using a synchronous ORM (like SQLAlchemy Core without async support) or a synchronous Redis client gives you the overhead of the event loop with none of the benefits. Audit every I/O library in your async service: if it is synchronous, run it in a thread pool or replace it with an async-native alternative.</div></details><details class=border-none data-accordion-item><summary class="flex w-full cursor-pointer items-center justify-between gap-4 px-4 py-3 text-left text-lg font-semibold text-neutral-900 dark:text-neutral-100"><span class="flex items-center gap-2"><span>Not handling task exceptions</span>
</span><span><span class="relative block icon"><svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></summary><div class="px-4 pb-4 text-neutral-700 dark:text-neutral-300">A task created with <code>create_task</code> that raises an unhandled exception will not propagate that exception to the parent coroutine. The exception is stored in the task object and Python emits a warning when the task is garbage-collected. Always attach a done callback or <code>await</code> the task at some point to surface exceptions.</div></details></div><style>#accordion-29a859743cbd465fc6093f5dd45f048b>details+details{border-top:1px solid rgb(var(--color-neutral-200))}.dark #accordion-29a859743cbd465fc6093f5dd45f048b>details+details{border-top-color:rgb(var(--color-neutral-700))}</style><script>(()=>{const e=document.getElementById("accordion-29a859743cbd465fc6093f5dd45f048b");if(!e)return;const t=e.querySelectorAll("details[data-accordion-item]");t.forEach(e=>{e.addEventListener("toggle",()=>{if(!e.open)return;t.forEach(t=>{t!==e&&t.removeAttribute("open")})})})})()</script><hr><p>If you want to go deeper on any of this, I offer 1:1 coaching sessions for engineers working on AI integration, cloud architecture, and platform engineering. <a href=https://calendly.com/manuelfedele/60min target=_blank rel=noreferrer>Book a session</a> (50 EUR / 60 min) or reach out at <a href=mailto:manuel.fedele+website@gmail.com>manuel.fedele+website@gmail.com</a>.</p></div><h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1516116216624-53e697fedbea?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/posts/create-webserver-with-fastapi-and-uvicorn/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Building Production APIs with FastAPI: Pydantic, Dependency Injection, and Deployment</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-12-30T14:08:35+01:00>30 December 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">6 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/fastapi/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Fastapi
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/uvicorn/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Uvicorn
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/webserver/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Webserver
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/pydantic/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Pydantic
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/production/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Production</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1574169208507-84376144848b?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/posts/what-does-yield-keyword-do-in-python/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Python Generators and yield: Building Memory-Efficient Pipelines</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2022-12-29T10:19:25+01:00>29 December 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/performance/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Performance
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/backend/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Backend</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class="flex-none relative overflow-hidden thumbnail_card_related"><img src="https://images.unsplash.com/photo-1523821741446-edb2b68bb7a0?w=1200&amp;q=85" role=presentation loading=lazy decoding=async fetchpriority=low class="not-prose absolute inset-0 w-full h-full object-cover"></div><div class=p-4><header><a href=/posts/poetry-no-module-seed-via-app-data/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Poetry No Module Seed via App Data</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2021-11-01T15:15:47+01:00>1 November 2021</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">1 min</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/poetry/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Poetry
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/python/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Python</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/create-a-telegram-bot-with-rust/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Building a Telegram Bot in Rust with Teloxide
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2022-12-31T14:26:23+01:00>31 December 2022</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/the-context-package/><span class=leading-6>The Go context Package: Cancellation, Timeouts, and Propagation in Production&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2023-01-03T20:36:29+01:00>3 January 2023</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Manuel Fedele</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://manuelfedele.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>