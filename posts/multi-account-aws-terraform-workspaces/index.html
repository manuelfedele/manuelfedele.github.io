<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Managing Multi-Account AWS Infrastructure with Terraform Workspaces &#183; Git Push and Run</title><meta name=title content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces &#183; Git Push and Run"><meta name=description content="Software Engineer and Cloud Architect writing about Go, Python, AWS, and AI automation."><meta name=keywords content="AWS,Terraform,IaC,DevOps,cloud,"><link rel=canonical href=https://manuelfedele.github.io/posts/multi-account-aws-terraform-workspaces/><meta name=author content="Manuel Fedele"><link href=https://github.com/manuelfedele rel=me><link href=https://linkedin.com/in/manuel-fedele rel=me><meta property="og:url" content="https://manuelfedele.github.io/posts/multi-account-aws-terraform-workspaces/"><meta property="og:site_name" content="Git Push and Run"><meta property="og:title" content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces"><meta property="og:description" content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces # When you’re managing infrastructure across dozens of AWS accounts, you need patterns that scale. In this post I’ll share the approach I use to manage multi-account, multi-environment AWS infrastructure using Terraform workspaces, modular code, and a consistent tagging strategy.
The Problem # Imagine this setup: you have multiple organizational scopes (teams, business units, projects), each with their own AWS accounts for non-production and production. On top of that, your non-production account hosts multiple environments (dev, integration, certification). Multiply this by several countries or regions, and you’re looking at a lot of infrastructure to manage."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-22T09:15:00+02:00"><meta property="article:modified_time" content="2025-09-22T09:15:00+02:00"><meta property="article:tag" content="AWS"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="IaC"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Cloud"><meta name=twitter:card content="summary"><meta name=twitter:title content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces"><meta name=twitter:description content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces # When you’re managing infrastructure across dozens of AWS accounts, you need patterns that scale. In this post I’ll share the approach I use to manage multi-account, multi-environment AWS infrastructure using Terraform workspaces, modular code, and a consistent tagging strategy.
The Problem # Imagine this setup: you have multiple organizational scopes (teams, business units, projects), each with their own AWS accounts for non-production and production. On top of that, your non-production account hosts multiple environments (dev, integration, certification). Multiply this by several countries or regions, and you’re looking at a lot of infrastructure to manage."><link type=text/css rel=stylesheet href=/css/main.bundle.min.726dfbf42bcd66e35e2d7258d72fe8fe77509ff76d153e2b46cdbae9c3af9620653459f0119a72d2af4a9b4bc446652d244ad58743d0290e5d8e09e3983b98e5.css integrity="sha512-cm379CvNZuNeLXJY1y/o/ndQn/dtFT4rRs266cOvliBlNFnwEZpy0q9Km0vERmUtJErVh0PQKQ5djgnjmDuY5Q=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.88278edec77139635e1ad294df5b32b7be9338191c5252d3f6f451ace5852d5f82390cccacedab9c64739d8e068b7e8502895cf8f951060c0368f9a73709fcb7.js integrity="sha512-iCeO3sdxOWNeGtKU31syt76TOBkcUlLT9vRRrOWFLV+COQzMrO2rnGRznY4Gi36FAolc+PlRBgwDaPmnNwn8tw==" data-copy=Copy data-copied=Copied></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Managing Multi-Account AWS Infrastructure with Terraform Workspaces","headline":"Managing Multi-Account AWS Infrastructure with Terraform Workspaces","inLanguage":"en","url":"https://manuelfedele.github.io/posts/multi-account-aws-terraform-workspaces/","author":{"@type":"Person","name":"Manuel Fedele"},"copyrightYear":"2025","dateCreated":"2025-09-22T09:15:00\u002b02:00","datePublished":"2025-09-22T09:15:00\u002b02:00","dateModified":"2025-09-22T09:15:00\u002b02:00","keywords":["AWS","Terraform","IaC","DevOps","cloud"],"mainEntityOfPage":"true","wordCount":"1344"}]</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-K9P1DJX238"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K9P1DJX238")</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">Git Push and Run</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title=Posts><span class="text-base font-medium break-normal">Blog
</span></a><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=About title=About><span class="text-base font-medium break-normal">About
</span></a><a href=https://github.com/manuelfedele target=_blank class="flex items-center bf-icon-color-hover" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Blog</span></a></div><div class=px-2><a href=/about/ aria-label=About class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=About class="text-2xl font-bold tracking-tight">About</span></a></div><div class=px-2><a href=https://github.com/manuelfedele aria-label=github target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span><span title class="text-2xl font-bold tracking-tight"></span></a></div></nav></div></div></div></div></div><script>(function(){var t,n,e=document.querySelector(".main-menu");if(!e)return;t=window.location.pathname,n=e.querySelectorAll('a[href="'+t+'"]'),n.forEach(function(e){var t=e.querySelectorAll("span");t.forEach(function(e){e.classList.add("active")})})})()</script></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Managing Multi-Account AWS Infrastructure with Terraform Workspaces</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-09-22T09:15:00+02:00>22 September 2025</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">7 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/aws/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">AWS
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/terraform/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Terraform
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/iac/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">IaC
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/devops/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">DevOps
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a></li><li><a href=#workspace-based-environment-separation>Workspace-Based Environment Separation</a></li><li><a href=#environment-specific-variables-with-lookup-maps>Environment-Specific Variables with Lookup Maps</a></li><li><a href=#modular-infrastructure>Modular Infrastructure</a></li><li><a href=#the-three-tier-security-group-pattern>The Three-Tier Security Group Pattern</a></li><li><a href=#iam-with-permissions-boundaries>IAM with Permissions Boundaries</a></li><li><a href=#waf-for-rate-limiting>WAF for Rate Limiting</a></li><li><a href=#cicd-integration>CI/CD Integration</a></li><li><a href=#lessons-learned>Lessons Learned</a></li><li><a href=#references>References</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a></li><li><a href=#workspace-based-environment-separation>Workspace-Based Environment Separation</a></li><li><a href=#environment-specific-variables-with-lookup-maps>Environment-Specific Variables with Lookup Maps</a></li><li><a href=#modular-infrastructure>Modular Infrastructure</a></li><li><a href=#the-three-tier-security-group-pattern>The Three-Tier Security Group Pattern</a></li><li><a href=#iam-with-permissions-boundaries>IAM with Permissions Boundaries</a></li><li><a href=#waf-for-rate-limiting>WAF for Rate Limiting</a></li><li><a href=#cicd-integration>CI/CD Integration</a></li><li><a href=#lessons-learned>Lessons Learned</a></li><li><a href=#references>References</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!0,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">Managing Multi-Account AWS Infrastructure with Terraform Workspaces<div id=managing-multi-account-aws-infrastructure-with-terraform-workspaces class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#managing-multi-account-aws-infrastructure-with-terraform-workspaces aria-label=Anchor>#</a></span></h1><p>When you&rsquo;re managing infrastructure across dozens of AWS accounts, you need patterns that scale. In this post I&rsquo;ll share the approach I use to manage multi-account, multi-environment AWS infrastructure using Terraform workspaces, modular code, and a consistent tagging strategy.</p><h2 class="relative group">The Problem<div id=the-problem class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-problem aria-label=Anchor>#</a></span></h2><p>Imagine this setup: you have multiple organizational scopes (teams, business units, projects), each with their own AWS accounts for non-production and production. On top of that, your non-production account hosts multiple environments (dev, integration, certification). Multiply this by several countries or regions, and you&rsquo;re looking at a lot of infrastructure to manage.</p><p>The naive approach of copy-pasting Terraform code per environment quickly becomes unmaintainable. You need a strategy that lets you define infrastructure once and deploy it consistently across all environments.</p><h2 class="relative group">Workspace-Based Environment Separation<div id=workspace-based-environment-separation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#workspace-based-environment-separation aria-label=Anchor>#</a></span></h2><p>Terraform workspaces are the foundation of this approach. Each workspace maps to an environment tier:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># terraform.tf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>terraform</span> {
</span></span><span class=line><span class=cl><span class=n>  required_version</span> <span class=o>=</span><span class=n> &#34;&gt;</span><span class=o>=</span> <span class=m>1</span><span class=p>.</span><span class=m>5</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>required_providers</span> {
</span></span><span class=line><span class=cl><span class=n>    aws</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      source</span>  <span class=o>=</span> <span class=s2>&#34;hashicorp/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>backend</span> <span class=s2>&#34;s3&#34;</span> {}
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><p>We use partial backend configuration with <code>.hcl</code> files per environment:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># backend-qual.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>bucket</span>         <span class=o>=</span> <span class=s2>&#34;my-scope-terraform-state-qual&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span>            <span class=o>=</span> <span class=s2>&#34;my-service/terraform.tfstate&#34;</span>
</span></span><span class=line><span class=cl><span class=n>region</span>         <span class=o>=</span> <span class=s2>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>dynamodb_table</span> <span class=o>=</span> <span class=s2>&#34;terraform-lock&#34;</span>
</span></span><span class=line><span class=cl><span class=n>encrypt</span>        <span class=o>=</span> <span class=kt>true</span></span></span></code></pre></div></div><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># backend-prod.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>bucket</span>         <span class=o>=</span> <span class=s2>&#34;my-scope-terraform-state-prod&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span>            <span class=o>=</span> <span class=s2>&#34;my-service/terraform.tfstate&#34;</span>
</span></span><span class=line><span class=cl><span class=n>region</span>         <span class=o>=</span> <span class=s2>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>dynamodb_table</span> <span class=o>=</span> <span class=s2>&#34;terraform-lock&#34;</span>
</span></span><span class=line><span class=cl><span class=n>encrypt</span>        <span class=o>=</span> <span class=kt>true</span></span></span></code></pre></div></div><p>Initialize with the appropriate backend:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init -backend-config<span class=o>=</span>backend-qual.hcl
</span></span><span class=line><span class=cl>terraform workspace <span class=k>select</span> qual <span class=o>||</span> terraform workspace new qual
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>terraform init -backend-config<span class=o>=</span>backend-prod.hcl
</span></span><span class=line><span class=cl>terraform workspace <span class=k>select</span> prod <span class=o>||</span> terraform workspace new prod</span></span></code></pre></div></div><h2 class="relative group">Environment-Specific Variables with Lookup Maps<div id=environment-specific-variables-with-lookup-maps class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#environment-specific-variables-with-lookup-maps aria-label=Anchor>#</a></span></h2><p>Instead of separate <code>.tfvars</code> files, I use lookup maps keyed by <code>terraform.workspace</code>. This keeps everything in one place and makes differences between environments immediately visible:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># locals.tf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  environment</span> <span class=o>=</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # ECS configuration per environment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  ecs_cpu</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>512</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>1024</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  ecs_memory</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>1024</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>2048</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>1024</span><span class=p>)</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Aurora Serverless v2 scaling
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  aurora_min_acu</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>0</span><span class=p>.</span><span class=m>5</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>0</span><span class=p>.</span><span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  aurora_max_acu</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>4</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>2</span><span class=p>)</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Fargate capacity provider strategy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  fargate_spot_weight</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>4</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  fargate_ondemand_weight</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>4</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>1</span><span class=p>)</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Common tags applied to all resources
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  common_tags</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    Environment</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>environment</span>
</span></span><span class=line><span class=cl><span class=n>    Project</span>     <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_name</span>
</span></span><span class=line><span class=cl><span class=n>    ManagedBy</span>   <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Team</span>        <span class=o>=</span> <span class=s2>&#34;platform&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><p>This pattern makes it easy to see at a glance how environments differ. Non-production gets smaller instances and more Spot capacity; production gets larger instances and more On-Demand stability.</p><h2 class="relative group">Modular Infrastructure<div id=modular-infrastructure class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#modular-infrastructure aria-label=Anchor>#</a></span></h2><p>Each infrastructure concern lives in its own module:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>terraform/
</span></span><span class=line><span class=cl>  modules/
</span></span><span class=line><span class=cl>    alb/
</span></span><span class=line><span class=cl>    aurora/
</span></span><span class=line><span class=cl>    cloudwatch/
</span></span><span class=line><span class=cl>    ecr/
</span></span><span class=line><span class=cl>    ecs/
</span></span><span class=line><span class=cl>    route53/
</span></span><span class=line><span class=cl>    security-groups/
</span></span><span class=line><span class=cl>    waf/
</span></span><span class=line><span class=cl>  main.tf
</span></span><span class=line><span class=cl>  locals.tf
</span></span><span class=line><span class=cl>  terraform.tf
</span></span><span class=line><span class=cl>  backend-qual.hcl
</span></span><span class=line><span class=cl>  backend-prod.hcl</span></span></code></pre></div></div><p>The root module composes them:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>module</span> <span class=s2>&#34;ecr&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>       <span class=o>=</span> <span class=s2>&#34;./modules/ecr&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_name</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>         <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;security_groups&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>   <span class=o>=</span> <span class=s2>&#34;./modules/security-groups&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>   <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_cidr</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>cidr_block</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>     <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;alb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>            <span class=o>=</span> <span class=s2>&#34;./modules/alb&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_name</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>            <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span>        <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnets</span><span class=p>.</span><span class=k>private</span><span class=p>.</span><span class=k>ids</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>security_groups</span><span class=p>.</span><span class=k>alb_sg_id</span>
</span></span><span class=line><span class=cl><span class=n>  certificate_arn</span>   <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_acm_certificate</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;ecs&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>              <span class=o>=</span> <span class=s2>&#34;./modules/ecs&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_name</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  cpu</span>                 <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>ecs_cpu</span>
</span></span><span class=line><span class=cl><span class=n>  memory</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>ecs_memory</span>
</span></span><span class=line><span class=cl><span class=n>  image</span>               <span class=o>=</span> <span class=s2>&#34;${module.ecr.repository_url}:latest&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  target_group_arn</span>    <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>target_group_arn</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span>   <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>security_groups</span><span class=p>.</span><span class=k>ecs_sg_id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span>          <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnets</span><span class=p>.</span><span class=k>private</span><span class=p>.</span><span class=k>ids</span>
</span></span><span class=line><span class=cl><span class=n>  spot_weight</span>         <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>fargate_spot_weight</span>
</span></span><span class=line><span class=cl><span class=n>  ondemand_weight</span>     <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>fargate_ondemand_weight</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>                <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;aurora&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>            <span class=o>=</span> <span class=s2>&#34;./modules/aurora&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  cluster_name</span>      <span class=o>=</span> <span class=s2>&#34;${var.service_name}-${local.environment}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  engine_version</span>    <span class=o>=</span> <span class=s2>&#34;16.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  min_acu</span>           <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>aurora_min_acu</span>
</span></span><span class=line><span class=cl><span class=n>  max_acu</span>           <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>aurora_max_acu</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>            <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span>        <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnets</span><span class=p>.</span><span class=k>database</span><span class=p>.</span><span class=k>ids</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>security_groups</span><span class=p>.</span><span class=k>aurora_sg_id</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><h2 class="relative group">The Three-Tier Security Group Pattern<div id=the-three-tier-security-group-pattern class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#the-three-tier-security-group-pattern aria-label=Anchor>#</a></span></h2><p>Every service follows the same layered security model:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># modules/security-groups/main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;alb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-alb-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>ingress</span> {
</span></span><span class=line><span class=cl><span class=n>    description</span> <span class=o>=</span> <span class=s2>&#34;HTTPS from VPC&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    from_port</span>   <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>     <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=k>var</span><span class=p>.</span><span class=k>vpc_cidr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>egress</span> {
</span></span><span class=line><span class=cl><span class=n>    from_port</span>   <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>     <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;ecs&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-ecs-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>ingress</span> {
</span></span><span class=line><span class=cl><span class=n>    description</span>     <span class=o>=</span> <span class=s2>&#34;Traffic from ALB&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    from_port</span>       <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>        <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    security_groups</span> <span class=o>=</span> <span class=p>[</span><span class=k>aws_security_group</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>egress</span> {
</span></span><span class=line><span class=cl><span class=n>    from_port</span>   <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>     <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;aurora&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-aurora-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>ingress</span> {
</span></span><span class=line><span class=cl><span class=n>    description</span>     <span class=o>=</span> <span class=s2>&#34;PostgreSQL from ECS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    from_port</span>       <span class=o>=</span> <span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>         <span class=o>=</span> <span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>        <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    security_groups</span> <span class=o>=</span> <span class=p>[</span><span class=k>aws_security_group</span><span class=p>.</span><span class=k>ecs</span><span class=p>.</span><span class=k>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><p>The key principle: each layer only accepts traffic from the layer above it. The ALB accepts HTTPS from the VPC, ECS accepts traffic only from the ALB security group, and Aurora accepts connections only from the ECS security group. No hardcoded CIDRs between tiers.</p><h2 class="relative group">IAM with Permissions Boundaries<div id=iam-with-permissions-boundaries class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#iam-with-permissions-boundaries aria-label=Anchor>#</a></span></h2><p>In an enterprise multi-account setup, you typically have a governance layer that constrains what each scope can do. Permissions boundaries are the mechanism:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_iam_role&#34; &#34;ecs_task&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-ecs-task-${local.environment}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  assume_role_policy</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    Version</span> <span class=o>=</span> <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Statement</span> <span class=o>=</span> <span class=p>[</span>{
</span></span><span class=line><span class=cl><span class=n>      Action</span> <span class=o>=</span> <span class=s2>&#34;sts:AssumeRole&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Effect</span> <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Principal</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        Service</span> <span class=o>=</span> <span class=s2>&#34;ecs-tasks.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }<span class=p>]</span>
</span></span><span class=line><span class=cl>  }<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  permissions_boundary</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_iam_policy</span><span class=p>.</span><span class=k>scope_boundary</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>                 <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><p>Every IAM role gets the scope&rsquo;s permissions boundary attached. This ensures that even if a role policy is overly permissive, it can&rsquo;t exceed what the organizational scope allows. The boundary is managed by a central governance team, not by individual project teams.</p><h2 class="relative group">WAF for Rate Limiting<div id=waf-for-rate-limiting class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#waf-for-rate-limiting aria-label=Anchor>#</a></span></h2><p>Every ALB gets a WAF with at least rate limiting and the AWS managed common rule set:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># modules/waf/main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_wafv2_web_acl&#34; &#34;main&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>  <span class=o>=</span> <span class=s2>&#34;${var.service_name}-waf-${var.environment}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  scope</span> <span class=o>=</span> <span class=s2>&#34;REGIONAL&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>default_action</span> {
</span></span><span class=line><span class=cl>    <span class=k>allow</span> {}
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>rule</span> {
</span></span><span class=line><span class=cl><span class=n>    name</span>     <span class=o>=</span> <span class=s2>&#34;rate-limit&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    priority</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>action</span> {
</span></span><span class=line><span class=cl>      <span class=k>block</span> {}
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>statement</span> {
</span></span><span class=line><span class=cl>      <span class=k>rate_based_statement</span> {
</span></span><span class=line><span class=cl><span class=n>        limit</span>              <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>rate_limit</span>
</span></span><span class=line><span class=cl><span class=n>        aggregate_key_type</span> <span class=o>=</span> <span class=s2>&#34;IP&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>visibility_config</span> {
</span></span><span class=line><span class=cl><span class=n>      cloudwatch_metrics_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      metric_name</span>                <span class=o>=</span> <span class=s2>&#34;${var.service_name}-rate-limit&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      sampled_requests_enabled</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>rule</span> {
</span></span><span class=line><span class=cl><span class=n>    name</span>     <span class=o>=</span> <span class=s2>&#34;aws-common-rules&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    priority</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override_action</span> {
</span></span><span class=line><span class=cl>      <span class=k>none</span> {}
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>statement</span> {
</span></span><span class=line><span class=cl>      <span class=k>managed_rule_group_statement</span> {
</span></span><span class=line><span class=cl><span class=n>        name</span>        <span class=o>=</span> <span class=s2>&#34;AWSManagedRulesCommonRuleSet&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        vendor_name</span> <span class=o>=</span> <span class=s2>&#34;AWS&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>visibility_config</span> {
</span></span><span class=line><span class=cl><span class=n>      cloudwatch_metrics_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      metric_name</span>                <span class=o>=</span> <span class=s2>&#34;${var.service_name}-common-rules&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      sampled_requests_enabled</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>visibility_config</span> {
</span></span><span class=line><span class=cl><span class=n>    cloudwatch_metrics_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>    metric_name</span>                <span class=o>=</span> <span class=s2>&#34;${var.service_name}-waf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    sampled_requests_enabled</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_wafv2_web_acl_association&#34; &#34;main&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  resource_arn</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>alb_arn</span>
</span></span><span class=line><span class=cl><span class=n>  web_acl_arn</span>  <span class=o>=</span> <span class=k>aws_wafv2_web_acl</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl>}</span></span></code></pre></div></div><h2 class="relative group">CI/CD Integration<div id=cicd-integration class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#cicd-integration aria-label=Anchor>#</a></span></h2><p>The GitLab CI pipeline follows a promotion flow. A commit to <code>master</code> triggers a plan; merging to <code>release</code> triggers apply:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>stages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>plan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>TF_PLUGIN_CACHE_DIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$CI_PROJECT_DIR/.terraform-plugins&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>terraform-plugins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>.terraform-plugins/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>.terraform_base</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>hashicorp/terraform:1.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform init -backend-config=backend-${ENVIRONMENT}.hcl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform workspace select ${ENVIRONMENT} || terraform workspace new ${ENVIRONMENT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plan:qual</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>plan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>qual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform plan -out=plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apply:qual</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>qual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform apply plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>plan:qual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plan:prod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>plan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform plan -out=plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apply:prod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform apply plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>plan:prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>manual</span></span></span></code></pre></div></div><p>Caching the Terraform plugin directory significantly speeds up pipeline runs when you have large provider downloads.</p><h2 class="relative group">Lessons Learned<div id=lessons-learned class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#lessons-learned aria-label=Anchor>#</a></span></h2><p>After managing this pattern across many scopes and projects, here&rsquo;s what I&rsquo;ve found works well:</p><ol><li><p><strong>Workspaces over directories.</strong> Having separate directories per environment leads to drift. Workspaces with lookup maps keep a single source of truth.</p></li><li><p><strong>Modules with opinions.</strong> Each module should embed best practices (deployment circuit breakers, Container Insights, log retention policies) rather than exposing every knob. If 90% of services need the same config, make it the default.</p></li><li><p><strong>Tag everything.</strong> Consistent tagging across all resources is what makes cost allocation, compliance reporting, and automated cleanup possible at scale.</p></li><li><p><strong>Permissions boundaries are non-negotiable.</strong> In a multi-team enterprise, you need guardrails. Permissions boundaries let teams self-serve within safe limits.</p></li><li><p><strong>Plan before apply, always.</strong> Even in non-production. A Terraform plan that shows 47 resources being destroyed is a lot cheaper to review than to recover from.</p></li></ol><h2 class="relative group">References<div id=references class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#references aria-label=Anchor>#</a></span></h2><ul><li><a href=https://developer.hashicorp.com/terraform/language/state/workspaces target=_blank rel=noreferrer>Terraform Workspaces Documentation</a></li><li><a href=https://docs.aws.amazon.com/wellarchitected/latest/framework/welcome.html target=_blank rel=noreferrer>AWS Well-Architected Framework - Multi-Account Strategy</a></li><li><a href=https://developer.hashicorp.com/terraform/language/modules/develop target=_blank rel=noreferrer>Terraform Module Best Practices</a></li></ul></div><h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><article class="article-link--related relative min-h-full min-w-full overflow-hidden rounded-lg border border-neutral-300 dark:border-neutral-600"><div class=p-4><header><a href=/posts/aws-opensearch-as-monitoring-tool/ class="not-prose before:absolute before:inset-0 decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 hover:underline hover:underline-offset-2"><h2>Aws Opensearch as Monitoring Tool</h2></a></header><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime=2023-07-12T08:42:00+02:00>12 July 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">5 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/aws/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">AWS
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/opensearch/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Opensearch
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/monitoring/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Monitoring
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/elasticsearch/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Elasticsearch
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/logging/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Logging
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/kibana/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kibana
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/cloudwatch/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloudwatch
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/lambda/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Lambda</span></span></a></div></div></div><div class="px-6 pt-4 pb-2"></div></article></section></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/evaluate-chess-position/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Building a Chess Engine - From Position Evaluation to Search Techniques
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-11-27T17:33:00+00:00>27 November 2024</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/building-interactive-cli-tools-in-go-with-bubbletea/><span class=leading-6>Building Interactive CLI Tools in Go with Bubbletea&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-11-14T10:30:00+01:00>14 November 2025</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Manuel Fedele</p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://manuelfedele.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>