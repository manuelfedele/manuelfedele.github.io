<!doctype html><html lang=en><head><title>Managing Multi-Account AWS Infrastructure with Terraform Workspaces :: Git Push and Run</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces When you&rsquo;re managing infrastructure across dozens of AWS accounts, you need patterns that scale. In this post I&rsquo;ll share the approach I use to manage multi-account, multi-environment AWS infrastructure using Terraform workspaces, modular code, and a consistent tagging strategy.
The Problem Imagine this setup: you have multiple organizational scopes (teams, business units, projects), each with their own AWS accounts for non-production and production. On top of that, your non-production account hosts multiple environments (dev, integration, certification). Multiply this by several countries or regions, and you&rsquo;re looking at a lot of infrastructure to manage.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://manuelfedele.github.io/posts/multi-account-aws-terraform-workspaces/><script async src="https://www.googletagmanager.com/gtag/js?id=G-K9P1DJX238"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K9P1DJX238")}</script><link rel=stylesheet href=https://manuelfedele.github.io/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css><link rel=stylesheet href=https://manuelfedele.github.io/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css><link rel=stylesheet href=https://manuelfedele.github.io/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css><link rel=stylesheet href=https://manuelfedele.github.io/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css><link rel=stylesheet href=https://manuelfedele.github.io/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css><link rel=stylesheet href=https://manuelfedele.github.io/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css><link rel=stylesheet href=https://manuelfedele.github.io/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css><link rel=stylesheet href=https://manuelfedele.github.io/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css><link rel=stylesheet href=https://manuelfedele.github.io/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css><link rel=stylesheet href=https://manuelfedele.github.io/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css><link rel=stylesheet href=https://manuelfedele.github.io/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css><link rel=stylesheet href=https://manuelfedele.github.io/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css><link rel=stylesheet href=https://manuelfedele.github.io/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css><link rel="shortcut icon" href=https://manuelfedele.github.io/favicon.png><link rel=apple-touch-icon href=https://manuelfedele.github.io/apple-touch-icon.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces"><meta property="og:description" content="Managing Multi-Account AWS Infrastructure with Terraform Workspaces When you&rsquo;re managing infrastructure across dozens of AWS accounts, you need patterns that scale. In this post I&rsquo;ll share the approach I use to manage multi-account, multi-environment AWS infrastructure using Terraform workspaces, modular code, and a consistent tagging strategy.
The Problem Imagine this setup: you have multiple organizational scopes (teams, business units, projects), each with their own AWS accounts for non-production and production. On top of that, your non-production account hosts multiple environments (dev, integration, certification). Multiply this by several countries or regions, and you&rsquo;re looking at a lot of infrastructure to manage.
"><meta property="og:url" content="https://manuelfedele.github.io/posts/multi-account-aws-terraform-workspaces/"><meta property="og:site_name" content="Git Push and Run"><meta property="og:image" content="https://manuelfedele.github.io/og-image.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-09-22 09:15:00 +0200 +0200"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>git push && run</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://manuelfedele.github.io/posts/multi-account-aws-terraform-workspaces/>Managing Multi-Account AWS Infrastructure with Terraform Workspaces</a></h1><div class=post-meta><time class=post-date>2025-09-22</time><span class=post-reading-time>7 min read (1333 words)</span></div><span class=post-tags>#<a href=https://manuelfedele.github.io/tags/aws/>AWS</a>&nbsp;
#<a href=https://manuelfedele.github.io/tags/terraform/>Terraform</a>&nbsp;
#<a href=https://manuelfedele.github.io/tags/iac/>IaC</a>&nbsp;
#<a href=https://manuelfedele.github.io/tags/devops/>DevOps</a>&nbsp;
#<a href=https://manuelfedele.github.io/tags/cloud/>cloud</a>&nbsp;</span><div class=table-of-contents><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a></li><li><a href=#workspace-based-environment-separation>Workspace-Based Environment Separation</a></li><li><a href=#environment-specific-variables-with-lookup-maps>Environment-Specific Variables with Lookup Maps</a></li><li><a href=#modular-infrastructure>Modular Infrastructure</a></li><li><a href=#the-three-tier-security-group-pattern>The Three-Tier Security Group Pattern</a></li><li><a href=#iam-with-permissions-boundaries>IAM with Permissions Boundaries</a></li><li><a href=#waf-for-rate-limiting>WAF for Rate Limiting</a></li><li><a href=#cicd-integration>CI/CD Integration</a></li><li><a href=#lessons-learned>Lessons Learned</a></li><li><a href=#references>References</a></li></ul></nav></div><div class=post-content><div><h1 id=managing-multi-account-aws-infrastructure-with-terraform-workspaces>Managing Multi-Account AWS Infrastructure with Terraform Workspaces<a href=#managing-multi-account-aws-infrastructure-with-terraform-workspaces class=hanchor arialabel=Anchor>#</a></h1><p>When you&rsquo;re managing infrastructure across dozens of AWS accounts, you need patterns that scale. In this post I&rsquo;ll share the approach I use to manage multi-account, multi-environment AWS infrastructure using Terraform workspaces, modular code, and a consistent tagging strategy.</p><h2 id=the-problem>The Problem<a href=#the-problem class=hanchor arialabel=Anchor>#</a></h2><p>Imagine this setup: you have multiple organizational scopes (teams, business units, projects), each with their own AWS accounts for non-production and production. On top of that, your non-production account hosts multiple environments (dev, integration, certification). Multiply this by several countries or regions, and you&rsquo;re looking at a lot of infrastructure to manage.</p><p>The naive approach of copy-pasting Terraform code per environment quickly becomes unmaintainable. You need a strategy that lets you define infrastructure once and deploy it consistently across all environments.</p><h2 id=workspace-based-environment-separation>Workspace-Based Environment Separation<a href=#workspace-based-environment-separation class=hanchor arialabel=Anchor>#</a></h2><p>Terraform workspaces are the foundation of this approach. Each workspace maps to an environment tier:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># terraform.tf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>terraform</span> {
</span></span><span class=line><span class=cl><span class=n>  required_version</span> <span class=o>=</span><span class=n> &#34;&gt;</span><span class=o>=</span> <span class=m>1</span><span class=p>.</span><span class=m>5</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>required_providers</span> {
</span></span><span class=line><span class=cl><span class=n>    aws</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      source</span>  <span class=o>=</span> <span class=s2>&#34;hashicorp/aws&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 5.0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>backend</span> <span class=s2>&#34;s3&#34;</span> {}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>We use partial backend configuration with <code>.hcl</code> files per environment:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># backend-qual.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>bucket</span>         <span class=o>=</span> <span class=s2>&#34;my-scope-terraform-state-qual&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span>            <span class=o>=</span> <span class=s2>&#34;my-service/terraform.tfstate&#34;</span>
</span></span><span class=line><span class=cl><span class=n>region</span>         <span class=o>=</span> <span class=s2>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>dynamodb_table</span> <span class=o>=</span> <span class=s2>&#34;terraform-lock&#34;</span>
</span></span><span class=line><span class=cl><span class=n>encrypt</span>        <span class=o>=</span> <span class=kt>true</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># backend-prod.hcl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>bucket</span>         <span class=o>=</span> <span class=s2>&#34;my-scope-terraform-state-prod&#34;</span>
</span></span><span class=line><span class=cl><span class=n>key</span>            <span class=o>=</span> <span class=s2>&#34;my-service/terraform.tfstate&#34;</span>
</span></span><span class=line><span class=cl><span class=n>region</span>         <span class=o>=</span> <span class=s2>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>dynamodb_table</span> <span class=o>=</span> <span class=s2>&#34;terraform-lock&#34;</span>
</span></span><span class=line><span class=cl><span class=n>encrypt</span>        <span class=o>=</span> <span class=kt>true</span>
</span></span></code></pre></div><p>Initialize with the appropriate backend:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform init -backend-config<span class=o>=</span>backend-qual.hcl
</span></span><span class=line><span class=cl>terraform workspace <span class=k>select</span> qual <span class=o>||</span> terraform workspace new qual
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>terraform init -backend-config<span class=o>=</span>backend-prod.hcl
</span></span><span class=line><span class=cl>terraform workspace <span class=k>select</span> prod <span class=o>||</span> terraform workspace new prod
</span></span></code></pre></div><h2 id=environment-specific-variables-with-lookup-maps>Environment-Specific Variables with Lookup Maps<a href=#environment-specific-variables-with-lookup-maps class=hanchor arialabel=Anchor>#</a></h2><p>Instead of separate <code>.tfvars</code> files, I use lookup maps keyed by <code>terraform.workspace</code>. This keeps everything in one place and makes differences between environments immediately visible:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># locals.tf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>locals</span> {
</span></span><span class=line><span class=cl><span class=n>  environment</span> <span class=o>=</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # ECS configuration per environment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  ecs_cpu</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>512</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>1024</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>512</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  ecs_memory</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>1024</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>2048</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>1024</span><span class=p>)</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Aurora Serverless v2 scaling
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  aurora_min_acu</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>0</span><span class=p>.</span><span class=m>5</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>0</span><span class=p>.</span><span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  aurora_max_acu</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>4</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>2</span><span class=p>)</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Fargate capacity provider strategy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  fargate_spot_weight</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>4</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  fargate_ondemand_weight</span> <span class=o>=</span> <span class=k>lookup</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    qual</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>    prod</span> <span class=o>=</span> <span class=m>4</span>
</span></span><span class=line><span class=cl>  }<span class=p>,</span> <span class=k>terraform</span><span class=p>.</span><span class=k>workspace</span><span class=p>,</span> <span class=m>1</span><span class=p>)</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # Common tags applied to all resources
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>  common_tags</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>    Environment</span> <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>environment</span>
</span></span><span class=line><span class=cl><span class=n>    Project</span>     <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>project_name</span>
</span></span><span class=line><span class=cl><span class=n>    ManagedBy</span>   <span class=o>=</span> <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Team</span>        <span class=o>=</span> <span class=s2>&#34;platform&#34;</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>This pattern makes it easy to see at a glance how environments differ. Non-production gets smaller instances and more Spot capacity; production gets larger instances and more On-Demand stability.</p><h2 id=modular-infrastructure>Modular Infrastructure<a href=#modular-infrastructure class=hanchor arialabel=Anchor>#</a></h2><p>Each infrastructure concern lives in its own module:</p><pre tabindex=0><code>terraform/
  modules/
    alb/
    aurora/
    cloudwatch/
    ecr/
    ecs/
    route53/
    security-groups/
    waf/
  main.tf
  locals.tf
  terraform.tf
  backend-qual.hcl
  backend-prod.hcl
</code></pre><p>The root module composes them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>module</span> <span class=s2>&#34;ecr&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>       <span class=o>=</span> <span class=s2>&#34;./modules/ecr&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_name</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>         <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;security_groups&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>   <span class=o>=</span> <span class=s2>&#34;./modules/security-groups&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>   <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_cidr</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>cidr_block</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>     <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;alb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>            <span class=o>=</span> <span class=s2>&#34;./modules/alb&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_name</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>            <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span>        <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnets</span><span class=p>.</span><span class=k>private</span><span class=p>.</span><span class=k>ids</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>security_groups</span><span class=p>.</span><span class=k>alb_sg_id</span>
</span></span><span class=line><span class=cl><span class=n>  certificate_arn</span>   <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_acm_certificate</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;ecs&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>              <span class=o>=</span> <span class=s2>&#34;./modules/ecs&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  service_name</span>        <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>service_name</span>
</span></span><span class=line><span class=cl><span class=n>  cpu</span>                 <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>ecs_cpu</span>
</span></span><span class=line><span class=cl><span class=n>  memory</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>ecs_memory</span>
</span></span><span class=line><span class=cl><span class=n>  image</span>               <span class=o>=</span> <span class=s2>&#34;${module.ecr.repository_url}:latest&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  target_group_arn</span>    <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>target_group_arn</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span>   <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>security_groups</span><span class=p>.</span><span class=k>ecs_sg_id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span>          <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnets</span><span class=p>.</span><span class=k>private</span><span class=p>.</span><span class=k>ids</span>
</span></span><span class=line><span class=cl><span class=n>  spot_weight</span>         <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>fargate_spot_weight</span>
</span></span><span class=line><span class=cl><span class=n>  ondemand_weight</span>     <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>fargate_ondemand_weight</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>                <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;aurora&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span>            <span class=o>=</span> <span class=s2>&#34;./modules/aurora&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  cluster_name</span>      <span class=o>=</span> <span class=s2>&#34;${var.service_name}-${local.environment}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  engine_version</span>    <span class=o>=</span> <span class=s2>&#34;16.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  min_acu</span>           <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>aurora_min_acu</span>
</span></span><span class=line><span class=cl><span class=n>  max_acu</span>           <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>aurora_max_acu</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>            <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_vpc</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>id</span>
</span></span><span class=line><span class=cl><span class=n>  subnet_ids</span>        <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_subnets</span><span class=p>.</span><span class=k>database</span><span class=p>.</span><span class=k>ids</span>
</span></span><span class=line><span class=cl><span class=n>  security_group_id</span> <span class=o>=</span> <span class=k>module</span><span class=p>.</span><span class=k>security_groups</span><span class=p>.</span><span class=k>aurora_sg_id</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>              <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h2 id=the-three-tier-security-group-pattern>The Three-Tier Security Group Pattern<a href=#the-three-tier-security-group-pattern class=hanchor arialabel=Anchor>#</a></h2><p>Every service follows the same layered security model:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># modules/security-groups/main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;alb&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-alb-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>ingress</span> {
</span></span><span class=line><span class=cl><span class=n>    description</span> <span class=o>=</span> <span class=s2>&#34;HTTPS from VPC&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    from_port</span>   <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>     <span class=o>=</span> <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=k>var</span><span class=p>.</span><span class=k>vpc_cidr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>egress</span> {
</span></span><span class=line><span class=cl><span class=n>    from_port</span>   <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>     <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;ecs&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-ecs-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>ingress</span> {
</span></span><span class=line><span class=cl><span class=n>    description</span>     <span class=o>=</span> <span class=s2>&#34;Traffic from ALB&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    from_port</span>       <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>         <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>container_port</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>        <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    security_groups</span> <span class=o>=</span> <span class=p>[</span><span class=k>aws_security_group</span><span class=p>.</span><span class=k>alb</span><span class=p>.</span><span class=k>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>egress</span> {
</span></span><span class=line><span class=cl><span class=n>    from_port</span>   <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>     <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>    <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_security_group&#34; &#34;aurora&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name_prefix</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-aurora-&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  vpc_id</span>      <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>vpc_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>ingress</span> {
</span></span><span class=line><span class=cl><span class=n>    description</span>     <span class=o>=</span> <span class=s2>&#34;PostgreSQL from ECS&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    from_port</span>       <span class=o>=</span> <span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=n>    to_port</span>         <span class=o>=</span> <span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=n>    protocol</span>        <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    security_groups</span> <span class=o>=</span> <span class=p>[</span><span class=k>aws_security_group</span><span class=p>.</span><span class=k>ecs</span><span class=p>.</span><span class=k>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>The key principle: each layer only accepts traffic from the layer above it. The ALB accepts HTTPS from the VPC, ECS accepts traffic only from the ALB security group, and Aurora accepts connections only from the ECS security group. No hardcoded CIDRs between tiers.</p><h2 id=iam-with-permissions-boundaries>IAM with Permissions Boundaries<a href=#iam-with-permissions-boundaries class=hanchor arialabel=Anchor>#</a></h2><p>In an enterprise multi-account setup, you typically have a governance layer that constrains what each scope can do. Permissions boundaries are the mechanism:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_iam_role&#34; &#34;ecs_task&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span> <span class=o>=</span> <span class=s2>&#34;${var.service_name}-ecs-task-${local.environment}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  assume_role_policy</span> <span class=o>=</span> <span class=k>jsonencode</span><span class=p>(</span>{
</span></span><span class=line><span class=cl><span class=n>    Version</span> <span class=o>=</span> <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    Statement</span> <span class=o>=</span> <span class=p>[</span>{
</span></span><span class=line><span class=cl><span class=n>      Action</span> <span class=o>=</span> <span class=s2>&#34;sts:AssumeRole&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Effect</span> <span class=o>=</span> <span class=s2>&#34;Allow&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      Principal</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>        Service</span> <span class=o>=</span> <span class=s2>&#34;ecs-tasks.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }<span class=p>]</span>
</span></span><span class=line><span class=cl>  }<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  permissions_boundary</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>aws_iam_policy</span><span class=p>.</span><span class=k>scope_boundary</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl><span class=n>  tags</span>                 <span class=o>=</span> <span class=k>local</span><span class=p>.</span><span class=k>common_tags</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Every IAM role gets the scope&rsquo;s permissions boundary attached. This ensures that even if a role policy is overly permissive, it can&rsquo;t exceed what the organizational scope allows. The boundary is managed by a central governance team, not by individual project teams.</p><h2 id=waf-for-rate-limiting>WAF for Rate Limiting<a href=#waf-for-rate-limiting class=hanchor arialabel=Anchor>#</a></h2><p>Every ALB gets a WAF with at least rate limiting and the AWS managed common rule set:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=c1># modules/waf/main.tf
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_wafv2_web_acl&#34; &#34;main&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>  <span class=o>=</span> <span class=s2>&#34;${var.service_name}-waf-${var.environment}&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  scope</span> <span class=o>=</span> <span class=s2>&#34;REGIONAL&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>default_action</span> {
</span></span><span class=line><span class=cl>    <span class=k>allow</span> {}
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>rule</span> {
</span></span><span class=line><span class=cl><span class=n>    name</span>     <span class=o>=</span> <span class=s2>&#34;rate-limit&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    priority</span> <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>action</span> {
</span></span><span class=line><span class=cl>      <span class=k>block</span> {}
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>statement</span> {
</span></span><span class=line><span class=cl>      <span class=k>rate_based_statement</span> {
</span></span><span class=line><span class=cl><span class=n>        limit</span>              <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>rate_limit</span>
</span></span><span class=line><span class=cl><span class=n>        aggregate_key_type</span> <span class=o>=</span> <span class=s2>&#34;IP&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>visibility_config</span> {
</span></span><span class=line><span class=cl><span class=n>      cloudwatch_metrics_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      metric_name</span>                <span class=o>=</span> <span class=s2>&#34;${var.service_name}-rate-limit&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      sampled_requests_enabled</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>rule</span> {
</span></span><span class=line><span class=cl><span class=n>    name</span>     <span class=o>=</span> <span class=s2>&#34;aws-common-rules&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    priority</span> <span class=o>=</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override_action</span> {
</span></span><span class=line><span class=cl>      <span class=k>none</span> {}
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>statement</span> {
</span></span><span class=line><span class=cl>      <span class=k>managed_rule_group_statement</span> {
</span></span><span class=line><span class=cl><span class=n>        name</span>        <span class=o>=</span> <span class=s2>&#34;AWSManagedRulesCommonRuleSet&#34;</span>
</span></span><span class=line><span class=cl><span class=n>        vendor_name</span> <span class=o>=</span> <span class=s2>&#34;AWS&#34;</span>
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>visibility_config</span> {
</span></span><span class=line><span class=cl><span class=n>      cloudwatch_metrics_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>      metric_name</span>                <span class=o>=</span> <span class=s2>&#34;${var.service_name}-common-rules&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      sampled_requests_enabled</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>visibility_config</span> {
</span></span><span class=line><span class=cl><span class=n>    cloudwatch_metrics_enabled</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>    metric_name</span>                <span class=o>=</span> <span class=s2>&#34;${var.service_name}-waf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>    sampled_requests_enabled</span>   <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  tags</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>tags</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;aws_wafv2_web_acl_association&#34; &#34;main&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  resource_arn</span> <span class=o>=</span> <span class=k>var</span><span class=p>.</span><span class=k>alb_arn</span>
</span></span><span class=line><span class=cl><span class=n>  web_acl_arn</span>  <span class=o>=</span> <span class=k>aws_wafv2_web_acl</span><span class=p>.</span><span class=k>main</span><span class=p>.</span><span class=k>arn</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><h2 id=cicd-integration>CI/CD Integration<a href=#cicd-integration class=hanchor arialabel=Anchor>#</a></h2><p>The GitLab CI pipeline follows a promotion flow. A commit to <code>master</code> triggers a plan; merging to <code>release</code> triggers apply:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>stages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>plan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>TF_PLUGIN_CACHE_DIR</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;$CI_PROJECT_DIR/.terraform-plugins&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>cache</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>terraform-plugins</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>.terraform-plugins/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>.terraform_base</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>hashicorp/terraform:1.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>before_script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform init -backend-config=backend-${ENVIRONMENT}.hcl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform workspace select ${ENVIRONMENT} || terraform workspace new ${ENVIRONMENT}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plan:qual</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>plan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>qual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform plan -out=plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apply:qual</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>qual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform apply plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>plan:qual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plan:prod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>plan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform plan -out=plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apply:prod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>extends</span><span class=p>:</span><span class=w> </span><span class=l>.terraform_base</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stage</span><span class=p>:</span><span class=w> </span><span class=l>apply</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variables</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ENVIRONMENT</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terraform apply plan.tfplan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>plan:prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>$CI_COMMIT_BRANCH == &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span></code></pre></div><p>Caching the Terraform plugin directory significantly speeds up pipeline runs when you have large provider downloads.</p><h2 id=lessons-learned>Lessons Learned<a href=#lessons-learned class=hanchor arialabel=Anchor>#</a></h2><p>After managing this pattern across many scopes and projects, here&rsquo;s what I&rsquo;ve found works well:</p><ol><li><p><strong>Workspaces over directories.</strong> Having separate directories per environment leads to drift. Workspaces with lookup maps keep a single source of truth.</p></li><li><p><strong>Modules with opinions.</strong> Each module should embed best practices (deployment circuit breakers, Container Insights, log retention policies) rather than exposing every knob. If 90% of services need the same config, make it the default.</p></li><li><p><strong>Tag everything.</strong> Consistent tagging across all resources is what makes cost allocation, compliance reporting, and automated cleanup possible at scale.</p></li><li><p><strong>Permissions boundaries are non-negotiable.</strong> In a multi-team enterprise, you need guardrails. Permissions boundaries let teams self-serve within safe limits.</p></li><li><p><strong>Plan before apply, always.</strong> Even in non-production. A Terraform plan that shows 47 resources being destroyed is a lot cheaper to review than to recover from.</p></li></ol><h2 id=references>References<a href=#references class=hanchor arialabel=Anchor>#</a></h2><ul><li><a href=https://developer.hashicorp.com/terraform/language/state/workspaces>Terraform Workspaces Documentation</a></li><li><a href=https://docs.aws.amazon.com/wellarchitected/latest/framework/welcome.html>AWS Well-Architected Framework - Multi-Account Strategy</a></li><li><a href=https://developer.hashicorp.com/terraform/language/modules/develop>Terraform Module Best Practices</a></li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h></span><hr></div><div class=pagination__buttons><a href=https://manuelfedele.github.io/posts/building-interactive-cli-tools-in-go-with-bubbletea/ class="button inline prev">&lt; [<span class=button__text>Building Interactive CLI Tools in Go with Bubbletea</span>]
</a>::
<a href=https://manuelfedele.github.io/posts/evaluate-chess-position/ class="button inline next">[<span class=button__text>Building a Chess Engine - From Position Evaluation to Search Techniques</span>] ></a></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2026 Powered by <a href=https://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>